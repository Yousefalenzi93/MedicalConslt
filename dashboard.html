<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - طريقتي العلاجي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Cairo', 'Tajawal', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        },
                        medical: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Emergency Login Modal -->
    <div id="emergencyLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white text-2xl">👨‍⚕️</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">تسجيل دخول سريع</h2>
                <p class="text-gray-600 mt-2">يبدو أنك لم تسجل الدخول بعد</p>
            </div>

            <div class="space-y-4">
                <button onclick="quickDoctorLogin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    👨‍⚕️ دخول كطبيب تجريبي
                </button>
                <button onclick="goToMainPage()" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                    🏠 العودة للصفحة الرئيسية
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center hover:opacity-80 transition-opacity">
                        <div class="w-10 h-10 bg-medical-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">ط</span>
                        </div>
                        <h1 class="mr-3 text-xl font-bold text-gray-800">طريقتي العلاجي</h1>
                    </a>
                </div>

                <div class="flex items-center space-x-4 space-x-reverse">
                    <a href="dashboard.html" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-lg transition-colors">
                        📊 لوحة التحكم
                    </a>
                    <a href="profile.html" class="text-gray-600 hover:text-gray-800 hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
                        👤 الملف الشخصي
                    </a>
                    <a href="test-auth.html" class="text-purple-600 hover:text-purple-800 hover:bg-purple-100 px-3 py-2 rounded-lg transition-colors">
                        🔍 اختبار المصادقة
                    </a>
                    <a href="register.html" class="text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-2 rounded-lg transition-colors">
                        📝 تسجيل طبيب جديد
                    </a>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm text-gray-600">مرحباً، <span data-user-name>د. فواز</span></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-700 px-3 py-2 rounded-lg hover:bg-red-50 transition-colors text-sm">
                            خروج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-7xl mx-auto px-4">
            <!-- Welcome Section -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">مرحباً، <span data-user-name>د. فواز</span></h1>
                <p class="text-gray-600">نظرة عامة على نشاطك في المنصة</p>
                <p class="text-sm text-gray-500 mt-1">التخصص: <span data-user-specialty>طب القلب</span></p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 text-xl">💬</span>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600">الاستشارات</p>
                            <p class="text-2xl font-bold text-gray-900">45</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-green-600 text-xl">📧</span>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600">الرسائل</p>
                            <p class="text-2xl font-bold text-gray-900">12</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-purple-600 text-xl">📅</span>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600">المواعيد</p>
                            <p class="text-2xl font-bold text-gray-900">8</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <span class="text-yellow-600 text-xl">⭐</span>
                        </div>
                        <div class="mr-4">
                            <p class="text-sm font-medium text-gray-600">التقييم</p>
                            <p class="text-2xl font-bold text-gray-900">4.8</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Platform Growth Section -->
            <div class="bg-white rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <span class="text-green-600 text-xl mr-2">📈</span>
                        نمو المنصة
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Monthly Growth Chart -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-4">📊 نمو الاستشارات الشهرية</h4>
                            <div class="relative h-48">
                                <canvas id="monthlyGrowthChart" class="w-full h-full"></canvas>
                            </div>
                            <div class="mt-3 text-sm text-blue-700">
                                <p>📈 زيادة 25% هذا الشهر</p>
                                <p>🎯 الهدف: 500 استشارة</p>
                            </div>
                        </div>

                        <!-- User Activity Chart -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-4">👥 نشاط الأطباء</h4>
                            <div class="relative h-48">
                                <canvas id="userActivityChart" class="w-full h-full"></canvas>
                            </div>
                            <div class="mt-3 text-sm text-green-700">
                                <p>🔥 120 طبيب نشط</p>
                                <p>⭐ معدل الرضا: 4.8/5</p>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Stats -->
                    <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600">342</div>
                            <div class="text-sm text-purple-700">استشارات هذا الأسبوع</div>
                            <div class="text-xs text-purple-500 mt-1">+15% من الأسبوع الماضي</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600">89</div>
                            <div class="text-sm text-orange-700">أطباء جدد</div>
                            <div class="text-xs text-orange-500 mt-1">+8% من الأسبوع الماضي</div>
                        </div>
                        <div class="bg-pink-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-pink-600">1,247</div>
                            <div class="text-sm text-pink-700">رسائل متبادلة</div>
                            <div class="text-xs text-pink-500 mt-1">+22% من الأسبوع الماضي</div>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-indigo-600">96%</div>
                            <div class="text-sm text-indigo-700">معدل الاستجابة</div>
                            <div class="text-xs text-indigo-500 mt-1">+3% من الأسبوع الماضي</div>
                        </div>
                    </div>

                    <!-- Real-time Activity -->
                    <div class="mt-6 bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            النشاط المباشر
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">الأطباء المتصلون:</span>
                                <span class="font-semibold text-green-600">47</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">الاستشارات النشطة:</span>
                                <span class="font-semibold text-blue-600">12</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">متوسط وقت الاستجابة:</span>
                                <span class="font-semibold text-purple-600">3.2 دقيقة</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Recent Consultations -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">الاستشارات الحديثة</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-900">مريض #1234</p>
                                        <p class="text-sm text-gray-600">طب القلب</p>
                                    </div>
                                    <div class="text-left">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                            جديدة
                                        </span>
                                        <p class="text-xs text-gray-500 mt-1">منذ 5 دقائق</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-900">مريض #1235</p>
                                        <p class="text-sm text-gray-600">طب عام</p>
                                    </div>
                                    <div class="text-left">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                            قيد المراجعة
                                        </span>
                                        <p class="text-xs text-gray-500 mt-1">منذ 15 دقيقة</p>
                                    </div>
                                </div>

                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-900">مريض #1236</p>
                                        <p class="text-sm text-gray-600">طب الأطفال</p>
                                    </div>
                                    <div class="text-left">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                            مكتملة
                                        </span>
                                        <p class="text-xs text-gray-500 mt-1">منذ ساعة</p>
                                    </div>
                                </div>
                            </div>
                            <button onclick="viewAllConsultations()" class="w-full mt-4 text-blue-600 hover:text-blue-700 font-medium">
                                عرض جميع الاستشارات
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Notifications -->
                <div class="space-y-6">
                    <!-- Quick Actions -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">إجراءات سريعة</h3>
                        </div>
                        <div class="p-6 space-y-3">
                            <button onclick="newConsultation()" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                💬 استشارة جديدة
                            </button>
                            <button onclick="scheduleAppointment()" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                📅 جدولة موعد
                            </button>
                            <a href="profile.html" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                👤 تحديث الملف الشخصي
                            </a>
                        </div>
                    </div>

                    <!-- Recent Messages -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">الرسائل الحديثة</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <div class="border-b border-gray-100 pb-3">
                                    <p class="font-medium text-sm text-gray-900">د. راكان</p>
                                    <p class="text-sm text-gray-600 truncate">شكراً لك على الاستشارة...</p>
                                    <p class="text-xs text-gray-500">منذ 10 دقائق</p>
                                </div>
                                <div class="border-b border-gray-100 pb-3">
                                    <p class="font-medium text-sm text-gray-900">إدارة المنصة</p>
                                    <p class="text-sm text-gray-600 truncate">تحديث جديد متاح...</p>
                                    <p class="text-xs text-gray-500">منذ ساعة</p>
                                </div>
                                <div class="pb-3">
                                    <p class="font-medium text-sm text-gray-900">د. مريم</p>
                                    <p class="text-sm text-gray-600 truncate">هل يمكنك مراجعة هذه الحالة؟</p>
                                    <p class="text-xs text-gray-500">منذ ساعتين</p>
                                </div>
                            </div>
                            <button onclick="viewAllMessages()" class="w-full mt-4 text-blue-600 hover:text-blue-700 font-medium text-sm">
                                عرض جميع الرسائل
                            </button>
                        </div>
                    </div>

                    <!-- Today's Schedule -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">جدول اليوم</h3>
                        </div>
                        <div class="p-6">
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <div class="w-16 text-sm font-medium text-gray-900">09:00</div>
                                    <div class="flex-1 text-sm text-gray-600">استشارة - طب القلب</div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-16 text-sm font-medium text-gray-900">11:30</div>
                                    <div class="flex-1 text-sm text-gray-600">اجتماع فريق طبي</div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-16 text-sm font-medium text-gray-900">14:00</div>
                                    <div class="flex-1 text-sm text-gray-600">مراجعة حالات</div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-16 text-sm font-medium text-gray-900">16:00</div>
                                    <div class="flex-1 text-sm text-gray-600">استشارة - طب عام</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="max-w-6xl mx-auto px-4">
            <div class="text-center">
                <!-- Founders Section -->
                <div class="bg-gradient-to-r from-blue-900/30 to-green-900/30 rounded-lg p-4 mb-4 border border-blue-500/20">
                    <h3 class="text-white font-bold mb-3 flex items-center justify-center text-sm">
                        <span class="text-yellow-400 mr-2">👑</span>
                        المؤسسون والمطورون
                        <span class="text-yellow-400 ml-2">👑</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                        <div class="bg-white/10 rounded-lg p-2 backdrop-blur-sm">
                            <div class="text-blue-300 font-semibold">د. فواز جمال الديدب</div>
                            <div class="text-blue-200 text-xs mt-1">🩺 استشاري باطنية</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2 backdrop-blur-sm">
                            <div class="text-green-300 font-semibold">محمد نفاع الرويلي</div>
                            <div class="text-green-200 text-xs mt-1">💊 صيدلي أول سموم</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2 backdrop-blur-sm">
                            <div class="text-purple-300 font-semibold">يوسف مسير العنزي</div>
                            <div class="text-purple-200 text-xs mt-1">💻 برمجة وتطوير</div>
                        </div>
                    </div>
                </div>

                <!-- Copyright -->
                <div class="text-gray-400 text-xs">
                    <p class="flex items-center justify-center mb-1">
                        <span class="text-blue-400 mr-1">©</span>
                        <span class="font-semibold">2024 طريقتي العلاجي</span>
                        <span class="text-blue-400 ml-1">©</span>
                    </p>
                    <p>جميع الحقوق محفوظة للمؤسسين والمطورين <span class="text-yellow-400">✨</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Debug function to show storage contents
        function debugStorage() {
            console.log('🔍 محتويات التخزين:');
            console.log('localStorage:', {
                currentUser: localStorage.getItem('currentUser'),
                userType: localStorage.getItem('userType')
            });
            console.log('sessionStorage:', {
                currentUser: sessionStorage.getItem('currentUser'),
                userType: sessionStorage.getItem('userType')
            });
        }

        // Enhanced user authentication check with fallback
        function checkUserAuth() {
            // Debug storage contents first
            debugStorage();

            // Check both localStorage and sessionStorage for compatibility
            let currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            let userType = localStorage.getItem('userType') || sessionStorage.getItem('userType');

            console.log('🔍 فحص حالة المستخدم:', {
                currentUser: !!currentUser,
                userType,
                localStorage: !!localStorage.getItem('currentUser'),
                sessionStorage: !!sessionStorage.getItem('currentUser'),
                url: window.location.href
            });

            // Check URL parameters for direct access
            const urlParams = new URLSearchParams(window.location.search);
            const directAccess = urlParams.get('user');

            if (directAccess === 'doctor') {
                console.log('🔑 وصول مباشر للطبيب من الرابط');
                // Create a default doctor user for direct access
                const defaultDoctor = {
                    name: 'د. مستخدم تجريبي',
                    license: 'DOC999',
                    email: 'test@tariqi-alilaji.com',
                    phone: '+966 50 123 4567',
                    userType: 'doctor',
                    specialty: 'طب عام'
                };

                localStorage.setItem('currentUser', JSON.stringify(defaultDoctor));
                localStorage.setItem('userType', 'doctor');
                sessionStorage.setItem('currentUser', JSON.stringify(defaultDoctor));
                sessionStorage.setItem('userType', 'doctor');

                currentUser = JSON.stringify(defaultDoctor);
                userType = 'doctor';
            }

            if (!currentUser || userType !== 'doctor') {
                console.log('❌ المستخدم غير مسجل أو ليس طبيب');

                // Show emergency login modal instead of alert
                showEmergencyLoginModal();
                return false;
            }

            try {
                const user = JSON.parse(currentUser);
                console.log('✅ مستخدم مسجل:', user.name);

                // تحديث اسم المستخدم في الصفحة
                const userNameElements = document.querySelectorAll('[data-user-name]');
                userNameElements.forEach(element => {
                    element.textContent = user.name || 'د. مستخدم';
                });

                // تحديث التخصص
                const specialtyElements = document.querySelectorAll('[data-user-specialty]');
                specialtyElements.forEach(element => {
                    element.textContent = user.specialty || 'طب عام';
                });

                // Update page title
                document.title = `لوحة التحكم - ${user.name || 'طبيب'}`;

                console.log('✅ تم تحديث بيانات المستخدم في الصفحة');

                // Sync data between localStorage and sessionStorage for compatibility
                if (!localStorage.getItem('currentUser')) {
                    localStorage.setItem('currentUser', currentUser);
                    localStorage.setItem('userType', userType);
                }
                if (!sessionStorage.getItem('currentUser')) {
                    sessionStorage.setItem('currentUser', currentUser);
                    sessionStorage.setItem('userType', userType);
                }

                return true;
            } catch (error) {
                console.error('❌ خطأ في قراءة بيانات المستخدم:', error);
                // Clear both storages
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userType');
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('userType');
                window.location.href = 'index.html';
                return false;
            }
        }

        // Emergency login functions
        function showEmergencyLoginModal() {
            console.log('🚨 عرض نموذج تسجيل الدخول الطارئ');
            document.getElementById('emergencyLoginModal').classList.remove('hidden');
        }

        function hideEmergencyLoginModal() {
            document.getElementById('emergencyLoginModal').classList.add('hidden');
        }

        function quickDoctorLogin() {
            console.log('⚡ تسجيل دخول سريع كطبيب');

            const doctorUser = {
                name: 'د. مستخدم تجريبي',
                license: 'QUICK001',
                email: 'quick@tariqi-alilaji.com',
                phone: '+966 50 123 4567',
                userType: 'doctor',
                specialty: 'طب عام'
            };

            // Save to both storages
            localStorage.setItem('currentUser', JSON.stringify(doctorUser));
            localStorage.setItem('userType', 'doctor');
            sessionStorage.setItem('currentUser', JSON.stringify(doctorUser));
            sessionStorage.setItem('userType', 'doctor');

            console.log('✅ تم حفظ بيانات الطبيب السريع');

            hideEmergencyLoginModal();

            // Reload page to apply changes
            window.location.reload();
        }

        function goToMainPage() {
            window.location.href = 'index.html';
        }

        // Enhanced logout function
        function logout() {
            console.log('🚪 تسجيل الخروج من لوحة التحكم...');

            // Clear both storages completely
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userType');
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('userType');

            // Show logout message
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = 'تم تسجيل الخروج بنجاح';
            document.body.appendChild(messageEl);

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        // Initialize page with delay to ensure data is saved
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 تحميل صفحة لوحة التحكم...');

            // Add a small delay to ensure localStorage/sessionStorage is ready
            setTimeout(() => {
                console.log('🔍 بدء فحص المصادقة...');

                if (checkUserAuth()) {
                    console.log('✅ تم التحقق من المصادقة بنجاح');

                    // Show welcome message
                    setTimeout(() => {
                        const messageEl = document.createElement('div');
                        messageEl.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        messageEl.textContent = 'مرحباً بك في لوحة التحكم!';
                        document.body.appendChild(messageEl);

                        setTimeout(() => {
                            if (document.body.contains(messageEl)) {
                                document.body.removeChild(messageEl);
                            }
                        }, 3000);
                    }, 500);
                } else {
                    console.log('❌ فشل في التحقق من المصادقة');
                }
            }, 100); // Small delay to ensure storage is ready
        });

        // Quick Actions Functions
        function newConsultation() {
            console.log('💬 بدء استشارة جديدة');

            // Create consultation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl">💬</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">استشارة جديدة</h2>
                        <p class="text-gray-600 mt-2">ابدأ استشارة طبية جديدة</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم المريض</label>
                            <input type="text" id="patientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="أدخل اسم المريض">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نوع الاستشارة</label>
                            <select id="consultationType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر نوع الاستشارة</option>
                                <option value="عامة">استشارة عامة</option>
                                <option value="طارئة">استشارة طارئة</option>
                                <option value="متابعة">متابعة</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">وصف الحالة</label>
                            <textarea id="caseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="اكتب وصف مختصر للحالة..."></textarea>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="startConsultation()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            بدء الاستشارة
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function scheduleAppointment() {
            console.log('📅 جدولة موعد جديد');

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl">📅</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">جدولة موعد</h2>
                        <p class="text-gray-600 mt-2">حدد موعد للمريض</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">اسم المريض</label>
                            <input type="text" id="appointmentPatient" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="أدخل اسم المريض">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ</label>
                            <input type="date" id="appointmentDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الوقت</label>
                            <input type="time" id="appointmentTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نوع الموعد</label>
                            <select id="appointmentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="">اختر نوع الموعد</option>
                                <option value="كشف">كشف عام</option>
                                <option value="متابعة">متابعة</option>
                                <option value="استشارة">استشارة</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="confirmAppointment()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            تأكيد الموعد
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                            إلغاء
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function viewAllConsultations() {
            console.log('👁️ عرض جميع الاستشارات');

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">جميع الاستشارات</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- Consultation 1 -->
                        <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors cursor-pointer" onclick="viewConsultationDetails('cons1')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">د. فواز</h3>
                                    <p class="text-sm text-gray-600">استشارة طبية - حالة قلبية معقدة</p>
                                    <p class="text-xs text-gray-500">اليوم، 2:30 م</p>
                                </div>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">مكتملة</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); viewConsultationDetails('cons1')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    👁️ عرض التفاصيل
                                </button>
                                <button onclick="event.stopPropagation(); downloadConsultationReport('cons1')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    📄 تقرير
                                </button>
                                <button onclick="event.stopPropagation(); followUpConsultation('cons1')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                    📞 متابعة
                                </button>
                            </div>
                        </div>

                        <!-- Consultation 2 -->
                        <div class="bg-blue-50 rounded-lg p-4 hover:bg-blue-100 transition-colors cursor-pointer border-l-4 border-blue-500" onclick="viewConsultationDetails('cons2')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">د. راكان</h3>
                                    <p class="text-sm text-gray-600">استشارة باطنة - إدارة ضغط الدم</p>
                                    <p class="text-xs text-gray-500">أمس، 11:15 ص</p>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">جارية</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); continueConsultation('cons2')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    💬 متابعة الآن
                                </button>
                                <button onclick="event.stopPropagation(); viewConsultationDetails('cons2')" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
                                    👁️ التفاصيل
                                </button>
                                <button onclick="event.stopPropagation(); completeConsultation('cons2')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    ✅ إنهاء
                                </button>
                            </div>
                        </div>

                        <!-- Consultation 3 -->
                        <div class="bg-red-50 rounded-lg p-4 hover:bg-red-100 transition-colors cursor-pointer border-l-4 border-red-500" onclick="viewConsultationDetails('cons3')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">د. خالد</h3>
                                    <p class="text-sm text-gray-600">استشارة طوارئ - حالة حمى معقدة</p>
                                    <p class="text-xs text-gray-500">أمس، 8:45 م</p>
                                </div>
                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full animate-pulse">عاجلة</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); urgentConsultation('cons3')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                                    🚨 رد عاجل
                                </button>
                                <button onclick="event.stopPropagation(); callPatient('cons3')" class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                                    📞 اتصال
                                </button>
                                <button onclick="event.stopPropagation(); referToSpecialist('cons3')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                    👨‍⚕️ تحويل
                                </button>
                            </div>
                        </div>

                        <!-- Consultation 4 -->
                        <div class="bg-yellow-50 rounded-lg p-4 hover:bg-yellow-100 transition-colors cursor-pointer border-l-4 border-yellow-500" onclick="viewConsultationDetails('cons4')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">د. مريم</h3>
                                    <p class="text-sm text-gray-600">استشارة نفسية - إدارة القلق والاكتئاب</p>
                                    <p class="text-xs text-gray-500">منذ 3 ساعات</p>
                                </div>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">في الانتظار</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); startConsultationAction('cons4')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    ▶️ بدء الاستشارة
                                </button>
                                <button onclick="event.stopPropagation(); viewPatientHistory('cons4')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    📋 التاريخ المرضي
                                </button>
                                <button onclick="event.stopPropagation(); scheduleConsultation('cons4')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                    📅 جدولة
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function viewAllMessages() {
            console.log('💬 عرض جميع الرسائل');

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">جميع الرسائل</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <!-- Message 1 - Unread -->
                        <div class="bg-blue-50 rounded-lg p-4 hover:bg-blue-100 transition-colors cursor-pointer border-l-4 border-blue-500" onclick="openMessage('msg1')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="font-medium text-gray-900">د. سارة أحمد</h3>
                                        <span class="w-2 h-2 bg-blue-500 rounded-full ml-2 animate-pulse"></span>
                                    </div>
                                    <p class="text-sm text-gray-600">هل يمكنك مراجعة هذه الحالة؟ المريض يعاني من أعراض غير واضحة...</p>
                                    <p class="text-xs text-gray-500">منذ ساعتين</p>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">جديدة</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); replyToMessage('msg1')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    💬 رد
                                </button>
                                <button onclick="event.stopPropagation(); forwardMessage('msg1')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    📤 إعادة توجيه
                                </button>
                                <button onclick="event.stopPropagation(); markAsRead('msg1')" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
                                    ✅ تم القراءة
                                </button>
                            </div>
                        </div>

                        <!-- Message 2 - System -->
                        <div class="bg-green-50 rounded-lg p-4 hover:bg-green-100 transition-colors cursor-pointer border-l-4 border-green-500" onclick="openMessage('msg2')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="font-medium text-gray-900">إدارة المنصة</h3>
                                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full ml-2">نظام</span>
                                    </div>
                                    <p class="text-sm text-gray-600">تحديث جديد على النظام - تم إضافة ميزات جديدة للاستشارات</p>
                                    <p class="text-xs text-gray-500">منذ 4 ساعات</p>
                                </div>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">إعلان</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); viewSystemUpdate('msg2')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    📋 عرض التحديث
                                </button>
                                <button onclick="event.stopPropagation(); dismissNotification('msg2')" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
                                    ❌ إخفاء
                                </button>
                            </div>
                        </div>

                        <!-- Message 3 - Thank you -->
                        <div class="bg-purple-50 rounded-lg p-4 hover:bg-purple-100 transition-colors cursor-pointer border-l-4 border-purple-500" onclick="openMessage('msg3')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">د. محمد علي</h3>
                                    <p class="text-sm text-gray-600">شكراً لك على المساعدة في الحالة الأخيرة، كانت نصائحك مفيدة جداً</p>
                                    <p class="text-xs text-gray-500">أمس</p>
                                </div>
                                <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">شكر</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); replyToMessage('msg3')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                    💬 رد
                                </button>
                                <button onclick="event.stopPropagation(); likeMessage('msg3')" class="bg-pink-600 text-white px-3 py-1 rounded text-xs hover:bg-pink-700">
                                    ❤️ إعجاب
                                </button>
                                <button onclick="event.stopPropagation(); archiveMessage('msg3')" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
                                    📁 أرشفة
                                </button>
                            </div>
                        </div>

                        <!-- Message 4 - Urgent -->
                        <div class="bg-red-50 rounded-lg p-4 hover:bg-red-100 transition-colors cursor-pointer border-l-4 border-red-500" onclick="openMessage('msg4')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="font-medium text-gray-900">د. خالد</h3>
                                        <span class="w-2 h-2 bg-red-500 rounded-full ml-2 animate-pulse"></span>
                                    </div>
                                    <p class="text-sm text-gray-600">حالة طارئة تحتاج استشارة فورية - مريض في العناية المركزة</p>
                                    <p class="text-xs text-gray-500">منذ 30 دقيقة</p>
                                </div>
                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full animate-pulse">عاجل</span>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="event.stopPropagation(); urgentReply('msg4')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                                    🚨 رد عاجل
                                </button>
                                <button onclick="event.stopPropagation(); callDoctor('msg4')" class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                                    📞 اتصال
                                </button>
                                <button onclick="event.stopPropagation(); escalateMessage('msg4')" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                    ⬆️ تصعيد
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="closeModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function startConsultation() {
            const patientName = document.getElementById('patientName').value;
            const consultationType = document.getElementById('consultationType').value;
            const caseDescription = document.getElementById('caseDescription').value;

            if (!patientName || !consultationType) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            console.log('بدء الاستشارة:', { patientName, consultationType, caseDescription });
            showSuccessMessage(`تم بدء استشارة جديدة للمريض: ${patientName}`);
            closeModal();
        }

        function confirmAppointment() {
            const patientName = document.getElementById('appointmentPatient').value;
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const type = document.getElementById('appointmentType').value;

            if (!patientName || !date || !time || !type) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            console.log('تأكيد الموعد:', { patientName, date, time, type });
            showSuccessMessage(`تم تأكيد موعد ${patientName} في ${date} الساعة ${time}`);
            closeModal();
        }

        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }

        // Consultation Functions
        function viewConsultationDetails(consultationId) {
            console.log('👁️ عرض تفاصيل الاستشارة:', consultationId);

            const consultations = {
                'cons1': {
                    doctor: 'د. فواز',
                    specialty: 'طب القلب',
                    hospital: 'مستشفى الملك فهد',
                    case: 'حالة قلبية معقدة',
                    symptoms: 'مريض 45 سنة يعاني من ألم حاد في الصدر الأيسر، ضيق في التنفس، تعرق',
                    diagnosis: 'التهاب في عضلة القلب - تم استبعاد الجلطة القلبية',
                    treatment: 'راحة تامة، مضادات الالتهاب، متابعة دورية مع تخطيط القلب',
                    medications: 'إيبوبروفين 400mg، أسبرين 75mg، ميتوبرولول 50mg',
                    status: 'مكتملة',
                    date: 'اليوم، 2:30 م',
                    duration: '45 دقيقة',
                    priority: 'متوسطة'
                },
                'cons2': {
                    doctor: 'د. راكان',
                    specialty: 'طب الباطنة',
                    hospital: 'مستشفى الملك فيصل',
                    case: 'إدارة ضغط الدم المقاوم',
                    symptoms: 'مريض 38 سنة يعاني من صداع مستمر، دوخة، خفقان في القلب',
                    diagnosis: 'ارتفاع ضغط الدم الأساسي مقاوم للعلاج التقليدي',
                    treatment: 'تعديل البروتوكول العلاجي، نظام غذائي منخفض الصوديوم، رياضة منتظمة',
                    medications: 'أملوديبين 10mg، ليسينوبريل 20mg، هيدروكلوروثيازيد 25mg',
                    status: 'جارية',
                    date: 'أمس، 11:15 ص',
                    duration: '30 دقيقة',
                    priority: 'عالية'
                },
                'cons3': {
                    doctor: 'د. خالد',
                    specialty: 'طب الطوارئ',
                    hospital: 'مستشفى الملك خالد',
                    case: 'حالة حمى معقدة',
                    symptoms: 'مريض 32 سنة يعاني من حمى شديدة 39.5°، قشعريرة، صداع حاد',
                    diagnosis: 'عدوى بكتيرية محتملة - يحتاج فحوصات إضافية',
                    treatment: 'مضادات حيوية واسعة المجال، خافضات حرارة، سوائل وريدية',
                    medications: 'سيفترياكسون 1g، باراسيتامول 1g، محلول ملحي',
                    status: 'عاجلة',
                    date: 'أمس، 8:45 م',
                    duration: '60 دقيقة',
                    priority: 'عاجلة'
                },
                'cons4': {
                    doctor: 'د. مريم',
                    specialty: 'الطب النفسي',
                    hospital: 'مستشفى الملك سلمان',
                    case: 'إدارة القلق والاكتئاب',
                    symptoms: 'مريضة 29 سنة تعاني من قلق شديد، اكتئاب، ضيق تنفس، صعوبة نوم',
                    diagnosis: 'اضطراب القلق المعمم مع نوبات اكتئاب متوسطة',
                    treatment: 'علاج نفسي معرفي سلوكي، تقنيات الاسترخاء، دعم اجتماعي',
                    medications: 'سيرترالين 50mg، لورازيبام 0.5mg عند الحاجة',
                    status: 'في الانتظار',
                    date: 'منذ 3 ساعات',
                    duration: 'غير محدد',
                    priority: 'متوسطة'
                }
            };

            const consultation = consultations[consultationId] || consultations['cons1'];

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-5xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-blue-600">👁️ تفاصيل الاستشارة الطبية</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Doctor Info -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="font-bold text-blue-800 mb-3">معلومات الطبيب المستشار</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center">
                                    <span class="text-2xl ml-2">👨‍⚕️</span>
                                    <div>
                                        <p class="font-semibold">${consultation.doctor}</p>
                                        <p class="text-gray-600">${consultation.specialty}</p>
                                    </div>
                                </div>
                                <p><strong>المستشفى:</strong> ${consultation.hospital}</p>
                                <p><strong>تاريخ الاستشارة:</strong> ${consultation.date}</p>
                                <p><strong>مدة الاستشارة:</strong> ${consultation.duration}</p>
                                <p><strong>الأولوية:</strong>
                                    <span class="px-2 py-1 rounded-full text-xs ${
                                        consultation.priority === 'عاجلة' ? 'bg-red-100 text-red-800' :
                                        consultation.priority === 'عالية' ? 'bg-orange-100 text-orange-800' :
                                        'bg-green-100 text-green-800'
                                    }">${consultation.priority}</span>
                                </p>
                            </div>
                        </div>

                        <!-- Case Details -->
                        <div class="lg:col-span-2 space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">🔍 تفاصيل الحالة:</h4>
                                <p class="text-sm text-gray-700">${consultation.case}</p>
                            </div>

                            <div class="bg-yellow-50 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2">📋 الأعراض والتاريخ المرضي:</h4>
                                <p class="text-sm text-yellow-700">${consultation.symptoms}</p>
                            </div>

                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2">🩺 التشخيص:</h4>
                                <p class="text-sm text-green-700">${consultation.diagnosis}</p>
                            </div>

                            <div class="bg-purple-50 rounded-lg p-4">
                                <h4 class="font-semibold text-purple-800 mb-2">💊 العلاج المقترح:</h4>
                                <p class="text-sm text-purple-700">${consultation.treatment}</p>
                            </div>

                            <div class="bg-orange-50 rounded-lg p-4">
                                <h4 class="font-semibold text-orange-800 mb-2">💉 الأدوية الموصوفة:</h4>
                                <p class="text-sm text-orange-700">${consultation.medications}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Actions -->
                    <div class="mt-6 bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-gray-800">حالة الاستشارة:</h4>
                            <span class="px-3 py-1 rounded-full text-sm ${
                                consultation.status === 'مكتملة' ? 'bg-green-100 text-green-800' :
                                consultation.status === 'جارية' ? 'bg-blue-100 text-blue-800' :
                                consultation.status === 'عاجلة' ? 'bg-red-100 text-red-800' :
                                'bg-yellow-100 text-yellow-800'
                            }">${consultation.status}</span>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="downloadDetailedReport('${consultationId}')" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                📄 تقرير مفصل
                            </button>
                            <button onclick="shareConsultation('${consultationId}')" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                                📤 مشاركة
                            </button>
                            <button onclick="addToFavorites('${consultationId}')" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                                ⭐ إضافة للمفضلة
                            </button>
                            <button onclick="printConsultation('${consultationId}')" class="bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
                                🖨️ طباعة
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="continueConsultation('${consultationId}')" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                            💬 متابعة الاستشارة
                        </button>
                        <button onclick="scheduleFollowUp()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            📅 جدولة متابعة
                        </button>
                        <button onclick="prescribeMedication()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            💊 وصف دواء
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function downloadConsultationReport(consultationId) {
            console.log('📄 تحميل تقرير الاستشارة:', consultationId);
            showSuccessMessage('جاري تحضير التقرير...');

            setTimeout(() => {
                showSuccessMessage('تم تحميل التقرير بنجاح');
            }, 2000);
        }

        function followUpConsultation(consultationId) {
            console.log('📞 متابعة الاستشارة:', consultationId);
            showInfoMessage('تم جدولة متابعة للمريض خلال أسبوع');
        }

        function continueConsultation(consultationId) {
            console.log('💬 متابعة الاستشارة الجارية:', consultationId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">💬 متابعة الاستشارة - د. راكان</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Doctor Info -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h3 class="font-bold text-blue-800 mb-3">معلومات الطبيب</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>الطبيب:</strong> د. راكان</p>
                                <p><strong>التخصص:</strong> طب الباطنة</p>
                                <p><strong>المستشفى:</strong> مستشفى الملك فيصل</p>
                                <p><strong>آخر تواصل:</strong> أمس، 11:15 ص</p>
                            </div>
                        </div>

                        <!-- Chat Area -->
                        <div class="lg:col-span-2">
                            <div class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto mb-4">
                                <div class="space-y-3">
                                    <div class="bg-blue-100 rounded-lg p-3 max-w-xs">
                                        <p class="text-sm">مرحباً زميلي، أحتاج استشارتك في حالة ضغط دم معقدة</p>
                                        <span class="text-xs text-gray-500">د. راكان - منذ ساعة</span>
                                    </div>
                                    <div class="bg-green-100 rounded-lg p-3 max-w-xs ml-auto">
                                        <p class="text-sm">أهلاً د. راكان، بالطبع. ما هي تفاصيل الحالة؟</p>
                                        <span class="text-xs text-gray-500">أنت - منذ 45 دقيقة</span>
                                    </div>
                                    <div class="bg-blue-100 rounded-lg p-3 max-w-xs">
                                        <p class="text-sm">مريض 45 سنة، ضغط مقاوم للعلاج، هل تنصح بتغيير البروتوكول؟</p>
                                        <span class="text-xs text-gray-500">د. راكان - منذ 30 دقيقة</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Message Input -->
                            <div class="flex space-x-2 space-x-reverse">
                                <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    إرسال
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="prescribeMedication()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            💊 وصف دواء
                        </button>
                        <button onclick="scheduleFollowUp()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            📅 جدولة متابعة
                        </button>
                        <button onclick="completeConsultation('${consultationId}')" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
                            ✅ إنهاء الاستشارة
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function completeConsultation(consultationId) {
            console.log('✅ إنهاء الاستشارة:', consultationId);
            if (confirm('هل أنت متأكد من إنهاء هذه الاستشارة؟')) {
                showSuccessMessage('تم إنهاء الاستشارة وإرسال التقرير للمريض');
            }
        }

        function urgentConsultation(consultationId) {
            console.log('🚨 استشارة عاجلة:', consultationId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-red-600">🚨 رد عاجل - د. خالد</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center mb-2">
                            <span class="text-red-600 text-xl mr-2">⚠️</span>
                            <h3 class="font-bold text-red-800">حالة طارئة</h3>
                        </div>
                        <p class="text-red-700 text-sm">المريض يعاني من حمى شديدة - يحتاج رد فوري</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Patient Emergency Info -->
                        <div class="bg-red-50 rounded-lg p-4">
                            <h3 class="font-bold text-red-800 mb-3">معلومات الحالة الطارئة</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>الطبيب:</strong> د. خالد</p>
                                <p><strong>التخصص:</strong> طب الطوارئ</p>
                                <p><strong>الأعراض:</strong> حمى شديدة (39.5°)</p>
                                <p><strong>الوقت:</strong> أمس، 8:45 م</p>
                                <p><strong>الحالة:</strong> <span class="text-red-600 font-bold">عاجلة</span></p>
                            </div>
                        </div>

                        <!-- Quick Response -->
                        <div class="space-y-4">
                            <h3 class="font-bold text-gray-800">الرد السريع</h3>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <h4 class="font-semibold text-yellow-800 mb-2">رسالة المريض:</h4>
                                <p class="text-sm text-yellow-700">"دكتور، حرارتي 39.5 درجة منذ 3 ساعات، أشعر بقشعريرة شديدة وصداع. ماذا أفعل؟"</p>
                            </div>

                            <textarea id="urgentResponse" rows="4" placeholder="اكتب ردك العاجل هنا..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
                        </div>
                    </div>

                    <!-- Quick Action Buttons -->
                    <div class="mt-6">
                        <h4 class="font-bold text-gray-800 mb-3">إجراءات سريعة:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="quickAdvice('fever')" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                🌡️ نصائح الحمى
                            </button>
                            <button onclick="prescribeUrgent()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                                💊 وصف عاجل
                            </button>
                            <button onclick="recommendER()" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                                🏥 توجه للطوارئ
                            </button>
                            <button onclick="callPatient('${consultationId}')" class="bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">
                                📞 اتصال فوري
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="sendUrgentResponse()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                            🚨 إرسال رد عاجل
                        </button>
                        <button onclick="escalateToER()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            ⬆️ تصعيد للطوارئ
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function callPatient(consultationId) {
            console.log('📞 اتصال بالمريض:', consultationId);
            showInfoMessage('جاري الاتصال بالمريض...');
        }

        function referToSpecialist(consultationId) {
            console.log('👨‍⚕️ تحويل لمختص:', consultationId);
            showSuccessMessage('تم تحويل الحالة لطبيب مختص');
        }

        function startConsultationAction(consultationId) {
            console.log('▶️ بدء الاستشارة:', consultationId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-5xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-green-600">▶️ بدء استشارة جديدة - د. مريم</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Patient Profile -->
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h3 class="font-bold text-purple-800 mb-3">ملف المريض</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex items-center">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23e5e7eb'/%3E%3Ctext x='20' y='25' text-anchor='middle' fill='%23374151' font-size='16'%3E👩%3C/text%3E%3C/svg%3E"
                                         alt="مريم" class="w-10 h-10 rounded-full ml-3">
                                    <div>
                                        <p class="font-semibold">د. مريم</p>
                                        <p class="text-gray-600">الطب النفسي</p>
                                    </div>
                                </div>
                                <div class="border-t pt-3">
                                    <p><strong>الحالة:</strong> قلق واكتئاب</p>
                                    <p><strong>النوع:</strong> استشارة نفسية</p>
                                    <p><strong>الوقت:</strong> منذ 3 ساعات</p>
                                    <p><strong>الأولوية:</strong> <span class="text-yellow-600">متوسطة</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Consultation Setup -->
                        <div class="lg:col-span-2 space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2">رسالة المريض الأولى:</h4>
                                <p class="text-sm text-green-700">"مرحباً دكتور، أعاني من قلق شديد وحالة اكتئاب منذ أسابيع. أشعر بضيق في التنفس وصعوبة في النوم. أحتاج مساعدتكم."</p>
                            </div>

                            <!-- Quick Assessment -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-3">تقييم سريع</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <label class="block font-medium mb-1">مستوى القلق (1-10):</label>
                                        <input type="range" min="1" max="10" value="7" class="w-full">
                                        <span class="text-blue-600">7 - مرتفع</span>
                                    </div>
                                    <div>
                                        <label class="block font-medium mb-1">مستوى الاكتئاب (1-10):</label>
                                        <input type="range" min="1" max="10" value="6" class="w-full">
                                        <span class="text-blue-600">6 - متوسط إلى مرتفع</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Initial Response -->
                            <div>
                                <label class="block font-semibold text-gray-800 mb-2">ردك الأولي:</label>
                                <textarea id="initialResponse" rows="4" placeholder="اكتب ردك الأولي والترحيب بالمريض..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">مرحباً مريم، أشكرك على ثقتك بي. أفهم ما تمرين به من قلق واكتئاب، وهذا أمر يمكن التعامل معه بفعالية. دعينا نبدأ بفهم حالتك أكثر...</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Consultation Tools -->
                    <div class="mt-6">
                        <h4 class="font-bold text-gray-800 mb-3">أدوات الاستشارة:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="openVideoCall()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                📹 مكالمة فيديو
                            </button>
                            <button onclick="openVoiceCall()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                                📞 مكالمة صوتية
                            </button>
                            <button onclick="shareScreen()" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                                🖥️ مشاركة الشاشة
                            </button>
                            <button onclick="sendFile()" class="bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">
                                📎 إرسال ملف
                            </button>
                            <button onclick="useTemplate()" class="bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
                                📋 قوالب جاهزة
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="startConsultationNow()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            ▶️ بدء الاستشارة الآن
                        </button>
                        <button onclick="scheduleForLater()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            📅 جدولة لاحقاً
                        </button>
                        <button onclick="requestMoreInfo()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                            ❓ طلب معلومات إضافية
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function viewPatientHistory(consultationId) {
            console.log('📋 عرض التاريخ المرضي:', consultationId);
            showInfoMessage('تم فتح ملف التاريخ المرضي للمريض');
        }

        function scheduleConsultation(consultationId) {
            console.log('📅 جدولة الاستشارة:', consultationId);
            showSuccessMessage('تم جدولة الاستشارة لموعد لاحق');
        }

        // Message Functions
        function openMessage(messageId) {
            console.log('📧 فتح الرسالة:', messageId);

            const messages = {
                'msg1': {
                    from: 'د. سارة أحمد',
                    subject: 'مراجعة حالة مريض',
                    content: 'هل يمكنك مراجعة هذه الحالة؟ المريض يعاني من أعراض غير واضحة وأحتاج رأيك الطبي.',
                    time: 'منذ ساعتين'
                },
                'msg2': {
                    from: 'إدارة المنصة',
                    subject: 'تحديث النظام',
                    content: 'تم إضافة ميزات جديدة للاستشارات تشمل الفيديو والملفات المرفقة.',
                    time: 'منذ 4 ساعات'
                }
            };

            const message = messages[messageId] || messages['msg1'];
            showInfoMessage(`رسالة من: ${message.from} - ${message.subject}`);
        }

        function replyToMessage(messageId) {
            console.log('💬 الرد على الرسالة:', messageId);
            showSuccessMessage('تم فتح نافذة الرد');
        }

        function forwardMessage(messageId) {
            console.log('📤 إعادة توجيه الرسالة:', messageId);
            showInfoMessage('تم فتح نافذة إعادة التوجيه');
        }

        function markAsRead(messageId) {
            console.log('✅ تم تحديد كمقروءة:', messageId);
            showSuccessMessage('تم تحديد الرسالة كمقروءة');
        }

        function viewSystemUpdate(messageId) {
            console.log('📋 عرض تحديث النظام:', messageId);
            showInfoMessage('تم فتح صفحة تفاصيل التحديث');
        }

        function dismissNotification(messageId) {
            console.log('❌ إخفاء الإشعار:', messageId);
            showSuccessMessage('تم إخفاء الإشعار');
        }

        function likeMessage(messageId) {
            console.log('❤️ إعجاب بالرسالة:', messageId);
            showSuccessMessage('تم إضافة إعجاب للرسالة');
        }

        function archiveMessage(messageId) {
            console.log('📁 أرشفة الرسالة:', messageId);
            showSuccessMessage('تم نقل الرسالة للأرشيف');
        }

        function urgentReply(messageId) {
            console.log('🚨 رد عاجل:', messageId);
            showWarningMessage('تم فتح نافذة الرد العاجل');
        }

        function callDoctor(messageId) {
            console.log('📞 اتصال بالطبيب:', messageId);
            showInfoMessage('جاري الاتصال بالطبيب...');
        }

        function escalateMessage(messageId) {
            console.log('⬆️ تصعيد الرسالة:', messageId);
            showWarningMessage('تم تصعيد الرسالة للإدارة');
        }

        // Utility Functions
        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 3000);
        }

        function showInfoMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 3000);
        }

        function showWarningMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 3000);
        }

        // Additional Functions for Consultation Modals

        // Chat Functions
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (input && input.value.trim()) {
                showSuccessMessage('تم إرسال الرسالة: ' + input.value);
                input.value = '';
            }
        }

        function prescribeMedication() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-green-600">💊 وصف دواء للطبيب</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Doctor Info -->
                        <div class="bg-green-50 rounded-lg p-4">
                            <h3 class="font-bold text-green-800 mb-3">معلومات الطبيب</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>الطبيب:</strong> د. راكان</p>
                                <p><strong>التخصص:</strong> طب الباطنة</p>
                                <p><strong>المستشفى:</strong> مستشفى الملك فيصل</p>
                                <p><strong>الحالة:</strong> ارتفاع ضغط الدم</p>
                            </div>
                        </div>

                        <!-- Prescription Form -->
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">اسم الدواء:</label>
                                <select id="medicationName" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">اختر الدواء</option>
                                    <option value="amlodipine">أملوديبين 5mg</option>
                                    <option value="lisinopril">ليسينوبريل 10mg</option>
                                    <option value="metformin">ميتفورمين 500mg</option>
                                    <option value="atorvastatin">أتورفاستاتين 20mg</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block font-semibold text-gray-700 mb-2">الجرعة:</label>
                                    <select id="dosage" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="once">مرة واحدة يومياً</option>
                                        <option value="twice">مرتين يومياً</option>
                                        <option value="three">ثلاث مرات يومياً</option>
                                        <option value="four">أربع مرات يومياً</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block font-semibold text-gray-700 mb-2">المدة:</label>
                                    <select id="duration" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="7">أسبوع واحد</option>
                                        <option value="14">أسبوعين</option>
                                        <option value="30">شهر واحد</option>
                                        <option value="90">ثلاثة أشهر</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">تعليمات خاصة:</label>
                                <textarea id="instructions" rows="3" placeholder="تعليمات إضافية للطبيب..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg">تناول الدواء مع الطعام، مراقبة ضغط الدم يومياً</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-semibold text-blue-800 mb-2">معاينة الوصفة:</h4>
                        <div id="prescriptionPreview" class="text-sm text-blue-700">
                            سيتم عرض الوصفة هنا بعد اختيار الدواء...
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="savePrescription()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            💾 حفظ الوصفة
                        </button>
                        <button onclick="sendPrescription()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            📤 إرسال للطبيب
                        </button>
                        <button onclick="printPrescription()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            🖨️ طباعة
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;

            // Add event listeners for real-time preview
            const medicationSelect = document.getElementById('medicationName');
            const dosageSelect = document.getElementById('dosage');
            const durationSelect = document.getElementById('duration');

            [medicationSelect, dosageSelect, durationSelect].forEach(element => {
                element.addEventListener('change', updatePrescriptionPreview);
            });
        }

        function scheduleFollowUp() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-600">📅 جدولة متابعة مع طبيب</h2>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-2xl">×</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Doctor Info -->
                        <div class="bg-purple-50 rounded-lg p-4">
                            <h3 class="font-bold text-purple-800 mb-3">معلومات الطبيب</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>الطبيب:</strong> د. راكان</p>
                                <p><strong>التخصص:</strong> طب الباطنة</p>
                                <p><strong>المستشفى:</strong> مستشفى الملك فيصل</p>
                                <p><strong>آخر استشارة:</strong> أمس، 11:15 ص</p>
                            </div>
                        </div>

                        <!-- Schedule Form -->
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">نوع المتابعة:</label>
                                <select id="followUpType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="consultation">استشارة طبية</option>
                                    <option value="checkup">فحص دوري</option>
                                    <option value="results">مراجعة نتائج</option>
                                    <option value="medication">متابعة دواء</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block font-semibold text-gray-700 mb-2">التاريخ:</label>
                                    <input type="date" id="followUpDate"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           min="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block font-semibold text-gray-700 mb-2">الوقت:</label>
                                    <select id="followUpTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="09:00">9:00 صباحاً</option>
                                        <option value="10:00">10:00 صباحاً</option>
                                        <option value="11:00">11:00 صباحاً</option>
                                        <option value="14:00">2:00 مساءً</option>
                                        <option value="15:00">3:00 مساءً</option>
                                        <option value="16:00">4:00 مساءً</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">طريقة المتابعة:</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="method" value="video" class="mr-2">
                                        <span>📹 مكالمة فيديو</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="method" value="voice" class="mr-2">
                                        <span>📞 مكالمة صوتية</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="method" value="chat" class="mr-2" checked>
                                        <span>💬 محادثة نصية</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">ملاحظات:</label>
                                <textarea id="followUpNotes" rows="3" placeholder="ملاحظات إضافية للمتابعة..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg">متابعة حالة ضغط الدم وفعالية العلاج الحالي</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-semibold text-yellow-800 mb-2">تذكير:</h4>
                        <div class="text-sm text-yellow-700">
                            <p>• سيتم إرسال تذكير للطبيب قبل الموعد بـ 24 ساعة</p>
                            <p>• يمكن إعادة جدولة الموعد حتى 2 ساعة قبل الوقت المحدد</p>
                            <p>• في حالة الطوارئ، يرجى التواصل فوراً</p>
                        </div>
                    </div>

                    <div class="flex space-x-4 space-x-reverse mt-6">
                        <button onclick="confirmSchedule()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                            ✅ تأكيد الجدولة
                        </button>
                        <button onclick="sendCalendarInvite()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            📧 إرسال دعوة
                        </button>
                        <button onclick="setReminder()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ⏰ تعيين تذكير
                        </button>
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;

            // Set default date to next week
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('followUpDate').value = nextWeek.toISOString().split('T')[0];
        }

        // Urgent Consultation Functions
        function quickAdvice(type) {
            const advice = {
                'fever': 'نصائح للحمى: راحة تامة، شرب سوائل كثيرة، كمادات باردة، مراقبة الحرارة'
            };
            showInfoMessage(advice[type] || 'نصيحة طبية عامة');
        }

        function prescribeUrgent() {
            showSuccessMessage('تم وصف: باراسيتامول 500mg كل 6 ساعات + مراجعة فورية إذا لم تتحسن الحالة');
        }

        function recommendER() {
            showWarningMessage('تم إرسال توصية للمريض بالتوجه فوراً لقسم الطوارئ');
        }

        function sendUrgentResponse() {
            const response = document.getElementById('urgentResponse');
            if (response && response.value.trim()) {
                showSuccessMessage('تم إرسال الرد العاجل للمريض');
                closeModal();
            } else {
                showWarningMessage('يرجى كتابة الرد أولاً');
            }
        }

        function escalateToER() {
            showWarningMessage('تم تصعيد الحالة لقسم الطوارئ - سيتم التواصل مع المريض خلال 5 دقائق');
            closeModal();
        }

        // Start Consultation Functions
        function openVideoCall() {
            showInfoMessage('جاري فتح مكالمة الفيديو...');
        }

        function openVoiceCall() {
            showInfoMessage('جاري بدء المكالمة الصوتية...');
        }

        function shareScreen() {
            showInfoMessage('تم تفعيل مشاركة الشاشة');
        }

        function sendFile() {
            showInfoMessage('تم فتح نافذة إرسال الملفات');
        }

        function useTemplate() {
            showInfoMessage('تم فتح القوالب الجاهزة للاستشارات النفسية');
        }

        function startConsultationNow() {
            const response = document.getElementById('initialResponse');
            if (response && response.value.trim()) {
                showSuccessMessage('تم بدء الاستشارة وإرسال الرد الأولي للمريض');
                closeModal();
            } else {
                showWarningMessage('يرجى كتابة الرد الأولي أولاً');
            }
        }

        function scheduleForLater() {
            showInfoMessage('تم جدولة الاستشارة لموعد لاحق - سيتم إشعار المريض');
            closeModal();
        }

        function requestMoreInfo() {
            showInfoMessage('تم إرسال طلب للطبيب لتقديم معلومات إضافية');
            closeModal();
        }

        // Prescription Functions
        function updatePrescriptionPreview() {
            const medication = document.getElementById('medicationName')?.value;
            const dosage = document.getElementById('dosage')?.value;
            const duration = document.getElementById('duration')?.value;
            const instructions = document.getElementById('instructions')?.value;

            const preview = document.getElementById('prescriptionPreview');
            if (preview && medication) {
                const medicationNames = {
                    'amlodipine': 'أملوديبين 5mg',
                    'lisinopril': 'ليسينوبريل 10mg',
                    'metformin': 'ميتفورمين 500mg',
                    'atorvastatin': 'أتورفاستاتين 20mg'
                };

                const dosageText = {
                    'once': 'مرة واحدة يومياً',
                    'twice': 'مرتين يومياً',
                    'three': 'ثلاث مرات يومياً',
                    'four': 'أربع مرات يومياً'
                };

                preview.innerHTML = `
                    <strong>الدواء:</strong> ${medicationNames[medication]}<br>
                    <strong>الجرعة:</strong> ${dosageText[dosage] || dosage}<br>
                    <strong>المدة:</strong> ${duration} يوم<br>
                    <strong>التعليمات:</strong> ${instructions || 'لا توجد تعليمات إضافية'}
                `;
            }
        }

        function savePrescription() {
            const medication = document.getElementById('medicationName')?.value;
            if (medication) {
                showSuccessMessage('تم حفظ الوصفة في ملف الطبيب');
            } else {
                showWarningMessage('يرجى اختيار الدواء أولاً');
            }
        }

        function sendPrescription() {
            const medication = document.getElementById('medicationName')?.value;
            if (medication) {
                showSuccessMessage('تم إرسال الوصفة للطبيب المختص');
                closeModal();
            } else {
                showWarningMessage('يرجى اختيار الدواء أولاً');
            }
        }

        function printPrescription() {
            const medication = document.getElementById('medicationName')?.value;
            if (medication) {
                showInfoMessage('جاري تحضير الوصفة للطباعة...');
                setTimeout(() => {
                    showSuccessMessage('تم إرسال الوصفة للطابعة');
                }, 2000);
            } else {
                showWarningMessage('يرجى اختيار الدواء أولاً');
            }
        }

        // Schedule Functions
        function confirmSchedule() {
            const date = document.getElementById('followUpDate')?.value;
            const time = document.getElementById('followUpTime')?.value;
            const type = document.getElementById('followUpType')?.value;

            if (date && time) {
                showSuccessMessage(`تم تأكيد الموعد: ${date} في ${time}`);
                closeModal();
            } else {
                showWarningMessage('يرجى اختيار التاريخ والوقت');
            }
        }

        function sendCalendarInvite() {
            const date = document.getElementById('followUpDate')?.value;
            if (date) {
                showInfoMessage('تم إرسال دعوة التقويم للطبيب');
            } else {
                showWarningMessage('يرجى اختيار التاريخ أولاً');
            }
        }

        function setReminder() {
            const date = document.getElementById('followUpDate')?.value;
            if (date) {
                showSuccessMessage('تم تعيين تذكير قبل الموعد بـ 24 ساعة');
            } else {
                showWarningMessage('يرجى اختيار التاريخ أولاً');
            }
        }

        // Consultation Details Functions
        function downloadDetailedReport(consultationId) {
            console.log('📄 تحميل تقرير مفصل:', consultationId);
            showSuccessMessage('جاري تحضير التقرير المفصل...');

            setTimeout(() => {
                showSuccessMessage('تم تحميل التقرير المفصل بنجاح - يحتوي على جميع تفاصيل الاستشارة');
            }, 2000);
        }

        function shareConsultation(consultationId) {
            console.log('📤 مشاركة الاستشارة:', consultationId);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">📤 مشاركة الاستشارة</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-xl">×</span>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <button onclick="shareViaEmail()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                            📧 مشاركة عبر البريد الإلكتروني
                        </button>
                        <button onclick="shareViaWhatsApp()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                            📱 مشاركة عبر واتساب
                        </button>
                        <button onclick="copyShareLink()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">
                            🔗 نسخ رابط المشاركة
                        </button>
                        <button onclick="generateQRCode()" class="w-full bg-orange-600 text-white py-2 px-4 rounded hover:bg-orange-700">
                            📱 إنشاء رمز QR
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <button onclick="closeModal()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function addToFavorites(consultationId) {
            console.log('⭐ إضافة للمفضلة:', consultationId);
            showSuccessMessage('تم إضافة الاستشارة للمفضلة - يمكنك الوصول إليها بسرعة لاحقاً');
        }

        function printConsultation(consultationId) {
            console.log('🖨️ طباعة الاستشارة:', consultationId);
            showInfoMessage('جاري تحضير الاستشارة للطباعة...');

            setTimeout(() => {
                showSuccessMessage('تم إرسال الاستشارة للطابعة');
            }, 1500);
        }

        // Share Functions
        function shareViaEmail() {
            showSuccessMessage('تم فتح تطبيق البريد الإلكتروني مع تفاصيل الاستشارة');
            closeModal();
        }

        function shareViaWhatsApp() {
            showSuccessMessage('تم فتح واتساب مع رابط الاستشارة');
            closeModal();
        }

        function copyShareLink() {
            showSuccessMessage('تم نسخ رابط الاستشارة إلى الحافظة');
            closeModal();
        }

        function generateQRCode() {
            showInfoMessage('تم إنشاء رمز QR للاستشارة - يمكن مسحه للوصول السريع');
            closeModal();
        }

        // Initialize Charts
        function initializeCharts() {
            // Monthly Growth Chart
            const monthlyCtx = document.getElementById('monthlyGrowthChart');
            if (monthlyCtx) {
                new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{
                            label: 'عدد الاستشارات',
                            data: [120, 190, 300, 250, 420, 380],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(59, 130, 246, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // User Activity Chart
            const activityCtx = document.getElementById('userActivityChart');
            if (activityCtx) {
                new Chart(activityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['أطباء نشطون', 'أطباء غير متصلين', 'أطباء جدد'],
                        datasets: [{
                            data: [120, 45, 25],
                            backgroundColor: [
                                'rgb(34, 197, 94)',
                                'rgb(156, 163, 175)',
                                'rgb(249, 115, 22)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeCharts, 500); // Small delay to ensure elements are rendered
        });

        // Update charts with real-time data (simulation)
        function updateChartsData() {
            // Simulate real-time updates
            const stats = document.querySelectorAll('.bg-purple-50 .text-2xl, .bg-orange-50 .text-2xl, .bg-pink-50 .text-2xl, .bg-indigo-50 .text-2xl');

            stats.forEach((stat, index) => {
                const currentValue = parseInt(stat.textContent);
                const variation = Math.floor(Math.random() * 10) - 5; // Random variation between -5 and +5
                const newValue = Math.max(0, currentValue + variation);

                if (index === 3) { // Percentage value
                    stat.textContent = Math.min(100, newValue) + '%';
                } else {
                    stat.textContent = newValue.toLocaleString();
                }
            });

            // Update real-time activity numbers
            const onlineDoctors = document.querySelector('.text-green-600');
            const activeConsultations = document.querySelector('.text-blue-600');
            const responseTime = document.querySelector('.text-purple-600');

            if (onlineDoctors) {
                const current = parseInt(onlineDoctors.textContent);
                onlineDoctors.textContent = Math.max(20, current + Math.floor(Math.random() * 6) - 3);
            }

            if (activeConsultations) {
                const current = parseInt(activeConsultations.textContent);
                activeConsultations.textContent = Math.max(0, current + Math.floor(Math.random() * 4) - 2);
            }

            if (responseTime) {
                const variation = (Math.random() * 0.6) - 0.3; // ±0.3 minutes
                const newTime = Math.max(1.0, 3.2 + variation);
                responseTime.textContent = newTime.toFixed(1) + ' دقيقة';
            }
        }

        // Update data every 30 seconds
        setInterval(updateChartsData, 30000);
    </script>
</body>
</html>
