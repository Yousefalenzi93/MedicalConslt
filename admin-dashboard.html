<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المدير - طريقتي العلاجي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            serverTimestamp,
            onSnapshot,
            addDoc,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import {
            getDatabase,
            ref,
            push,
            set,
            get,
            remove,
            onValue,
            off
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import {
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getAnalytics
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase configuration - Updated with complete settings
        const firebaseConfig = {
            apiKey: "AIzaSyDsrOCUDUevhiv2rYc5ATx4NTnBkKQ-T9k",
            authDomain: "mtmconsult-f48f1.firebaseapp.com",
            databaseURL: "https://mtmconsult-f48f1-default-rtdb.firebaseio.com",
            projectId: "mtmconsult-f48f1",
            storageBucket: "mtmconsult-f48f1.firebasestorage.app",
            messagingSenderId: "668149959230",
            appId: "1:668149959230:web:06c54fd158d03faf8e9f6f",
            measurementId: "G-TR97F5BZ7L"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.db = db;
        window.realtimeDb = realtimeDb;
        window.auth = auth;
        window.analytics = analytics;
        window.firebaseModules = {
            // Firestore modules
            collection,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            serverTimestamp,
            onSnapshot,
            addDoc,
            getDoc,
            // Realtime Database modules
            ref,
            push,
            set,
            get,
            remove,
            onValue,
            off,
            // Auth modules
            signInWithEmailAndPassword,
            onAuthStateChanged
        };

        console.log('🔥 Firebase تم تحميله بنجاح مع Firestore و Realtime Database');

        // Database helper functions
        window.dbHelpers = {
            // Choose between Firestore and Realtime Database
            useFirestore: true, // Set to false to use Realtime Database

            // Get data from preferred database
            async getData(path) {
                if (this.useFirestore) {
                    const { collection, getDocs } = window.firebaseModules;
                    const snapshot = await getDocs(collection(window.db, path));
                    const data = [];
                    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                    return data;
                } else {
                    const { ref, get } = window.firebaseModules;
                    const snapshot = await get(ref(window.realtimeDb, path));
                    return snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                }
            },

            // Add data to preferred database
            async addData(path, data) {
                if (this.useFirestore) {
                    const { collection, addDoc, serverTimestamp } = window.firebaseModules;
                    return await addDoc(collection(window.db, path), {
                        ...data,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                } else {
                    const { ref, push } = window.firebaseModules;
                    return await push(ref(window.realtimeDb, path), {
                        ...data,
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                }
            },

            // Update data in preferred database
            async updateData(path, id, data) {
                if (this.useFirestore) {
                    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
                    return await updateDoc(doc(window.db, path, id), {
                        ...data,
                        updatedAt: serverTimestamp()
                    });
                } else {
                    const { ref, set } = window.firebaseModules;
                    return await set(ref(window.realtimeDb, `${path}/${id}`), {
                        ...data,
                        updatedAt: Date.now()
                    });
                }
            },

            // Delete data from preferred database
            async deleteData(path, id) {
                if (this.useFirestore) {
                    const { doc, deleteDoc } = window.firebaseModules;
                    return await deleteDoc(doc(window.db, path, id));
                } else {
                    const { ref, remove } = window.firebaseModules;
                    return await remove(ref(window.realtimeDb, `${path}/${id}`));
                }
            }
        };

        // Performance monitoring
        window.performanceMonitor = {
            startTime: null,

            start(operation) {
                this.startTime = performance.now();
                console.log(`⏱️ بدء ${operation}...`);
            },

            end(operation) {
                if (this.startTime) {
                    const duration = performance.now() - this.startTime;
                    console.log(`✅ انتهى ${operation} في ${duration.toFixed(2)}ms`);
                    this.startTime = null;
                    return duration;
                }
            }
        };
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Cairo', 'Tajawal', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        },
                        medical: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1'
                        },
                        admin: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .admin-warning { 
            background: linear-gradient(45deg, #fee2e2, #fecaca);
            border: 2px solid #f87171;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Security Check -->
    <script>
        // Simple security check - in real app, this would be server-side
        const isAdmin = sessionStorage.getItem('userType') === 'admin';
        if (!isAdmin) {
            alert('⚠️ غير مصرح لك بالوصول لهذه الصفحة');
            window.location.href = 'index.html';
        }
    </script>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center hover:opacity-80 transition-opacity">
                        <div class="w-10 h-10 bg-admin-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-xl">⚙️</span>
                        </div>
                        <h1 class="mr-3 text-xl font-bold text-gray-800">طريقتي العلاجي - المدير</h1>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="admin-warning px-3 py-2 rounded-lg">
                        <span class="text-admin-700 font-medium text-sm">⚠️ وضع المدير</span>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-sm text-admin-600 font-medium">مرحباً، مدير المنصة</span>
                        <a href="index.html" onclick="logout()" class="text-red-600 hover:text-red-700 px-3 py-2 rounded-lg hover:bg-red-50 transition-colors text-sm">
                            خروج
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-7xl mx-auto px-4">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">لوحة تحكم المدير</h1>
                <p class="text-gray-600">مرحباً مدير المنصة - إدارة شاملة لمنصة طريقتي العلاجي</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="mb-8">
                <nav class="flex space-x-8 space-x-reverse">
                    <button onclick="showTab('overview')" id="tab-overview" class="flex items-center px-3 py-2 text-sm font-medium rounded-md bg-admin-100 text-admin-700">
                        <span class="ml-2">📊</span>
                        نظرة عامة
                    </button>
                    <button onclick="showTab('doctors')" id="tab-doctors" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <span class="ml-2">👥</span>
                        إدارة الأطباء
                    </button>
                    <button onclick="showTab('requests')" id="tab-requests" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <span class="ml-2">📋</span>
                        طلبات الانضمام
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <span class="ml-2">📈</span>
                        التقارير
                    </button>
                    <button onclick="showTab('settings')" id="tab-settings" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <span class="ml-2">⚙️</span>
                        الإعدادات
                    </button>
                </nav>
            </div>

            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-blue-600 text-xl">👥</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">إجمالي الأطباء</p>
                                <p class="text-2xl font-bold text-gray-900">2,847</p>
                                <p class="text-xs text-green-600">+12.5% هذا الشهر</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-green-600 text-xl">💬</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">إجمالي الاستشارات</p>
                                <p class="text-2xl font-bold text-gray-900">15,420</p>
                                <p class="text-xs text-green-600">+8.3% هذا الشهر</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <span class="text-purple-600 text-xl">🟢</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">المستخدمين النشطين</p>
                                <p class="text-2xl font-bold text-gray-900">342</p>
                                <p class="text-xs text-gray-500">الآن</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <span class="text-orange-600 text-xl">📋</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">طلبات الانضمام</p>
                                <p class="text-2xl font-bold text-gray-900">23</p>
                                <p class="text-xs text-orange-600">في الانتظار</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts and Recent Activity -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Growth Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">نمو المنصة</h3>
                        <div class="h-64 bg-gray-50 rounded-lg flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-4xl mb-2">📈</div>
                                <p class="text-gray-600">رسم بياني لنمو المنصة</p>
                                <p class="text-sm text-gray-500">سيتم إضافة المخططات قريباً</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">الأنشطة الحديثة</h3>
                        <div class="space-y-3">
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center ml-3">
                                    <span class="text-blue-600 text-sm">🔑</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">تسجيل دخول</p>
                                    <p class="text-xs text-gray-600">د. أحمد محمد • منذ 5 دقائق</p>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center ml-3">
                                    <span class="text-green-600 text-sm">💬</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">استشارة جديدة</p>
                                    <p class="text-xs text-gray-600">د. فاطمة علي • منذ 15 دقيقة</p>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center ml-3">
                                    <span class="text-purple-600 text-sm">👤</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">تحديث الملف الشخصي</p>
                                    <p class="text-xs text-gray-600">د. محمد سالم • منذ 30 دقيقة</p>
                                </div>
                            </div>
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center ml-3">
                                    <span class="text-orange-600 text-sm">📝</span>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">طلب انضمام جديد</p>
                                    <p class="text-xs text-gray-600">د. سارة أحمد • منذ ساعة</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Doctors Management Tab -->
            <div id="content-doctors" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-900">إدارة الأطباء</h3>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="refreshDoctors()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                    🔄 تحديث
                                </button>
                                <button onclick="exportDoctors()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    📊 تصدير
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="doctorsLoading" class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p class="mt-2 text-gray-600">جاري تحميل بيانات الأطباء...</p>
                        </div>

                        <!-- Doctors Table -->
                        <div id="doctorsTable" class="hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الطبيب</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التخصص</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المستشفى</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ التسجيل</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="doctorsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- سيتم ملء البيانات من Firebase -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="doctorsEmpty" class="hidden text-center py-12">
                            <div class="text-6xl mb-4">👨‍⚕️</div>
                            <p class="text-gray-600">لا توجد أطباء مسجلين حالياً</p>
                            <p class="text-sm text-gray-500">سيظهر الأطباء هنا بعد تسجيلهم في المنصة</p>
                        </div>

                        <!-- Error State -->
                        <div id="doctorsError" class="hidden text-center py-12">
                            <div class="text-6xl mb-4">⚠️</div>
                            <p class="text-red-600">حدث خطأ في تحميل بيانات الأطباء</p>
                            <button onclick="loadDoctors()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                إعادة المحاولة
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="content-requests" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">طلبات الانضمام المعلقة</h3>
                        <button onclick="refreshRequests()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                            🔄 تحديث
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div id="requestsLoading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <p class="mt-2 text-gray-600">جاري تحميل طلبات الانضمام...</p>
                    </div>

                    <!-- Requests List -->
                    <div id="requestsList" class="hidden space-y-4">
                        <!-- سيتم ملء الطلبات من Firebase -->
                    </div>

                    <!-- Empty State -->
                    <div id="requestsEmpty" class="hidden text-center py-12">
                        <div class="text-6xl mb-4">📋</div>
                        <p class="text-gray-600">لا توجد طلبات انضمام معلقة</p>
                        <p class="text-sm text-gray-500">ستظهر الطلبات الجديدة هنا</p>
                    </div>

                    <!-- Error State -->
                    <div id="requestsError" class="hidden text-center py-12">
                        <div class="text-6xl mb-4">⚠️</div>
                        <p class="text-red-600">حدث خطأ في تحميل طلبات الانضمام</p>
                        <button onclick="loadRequests()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            إعادة المحاولة
                        </button>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="content-reports" class="tab-content hidden">
                <!-- Report Header -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">التقارير والتحليلات</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <select id="reportPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                                <option value="month" selected>هذا الشهر</option>
                                <option value="year">هذا العام</option>
                            </select>
                            <button onclick="exportReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                📊 تصدير التقرير
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-blue-600 text-xl">👥</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">أطباء جدد</p>
                                <p class="text-2xl font-bold text-gray-900">47</p>
                                <p class="text-xs text-green-600">+12.5% من الشهر الماضي</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <span class="text-green-600 text-xl">💬</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">استشارات مكتملة</p>
                                <p class="text-2xl font-bold text-gray-900">1,234</p>
                                <p class="text-xs text-green-600">+8.3% من الشهر الماضي</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <span class="text-purple-600 text-xl">⭐</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">متوسط التقييم</p>
                                <p class="text-2xl font-bold text-gray-900">4.7</p>
                                <p class="text-xs text-green-600">+0.2 من الشهر الماضي</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <span class="text-orange-600 text-xl">💰</span>
                            </div>
                            <div class="mr-4">
                                <p class="text-sm font-medium text-gray-600">الإيرادات</p>
                                <p class="text-2xl font-bold text-gray-900">₹45,230</p>
                                <p class="text-xs text-green-600">+15.2% من الشهر الماضي</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Growth Chart -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">نمو المنصة الشهري</h4>
                        <div class="h-64 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg flex items-center justify-center relative">
                            <canvas id="growthChart" class="absolute inset-0 w-full h-full"></canvas>
                            <div class="text-center z-10">
                                <div class="text-4xl mb-2">📈</div>
                                <p class="text-gray-600 font-medium">نمو مستمر</p>
                                <p class="text-sm text-gray-500">+12.5% هذا الشهر</p>
                            </div>
                        </div>
                    </div>

                    <!-- Specialties Distribution -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">توزيع التخصصات</h4>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-blue-500 rounded-full ml-2"></div>
                                    <span class="text-sm text-gray-700">طب القلب</span>
                                </div>
                                <span class="text-sm font-medium text-gray-900">23%</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-green-500 rounded-full ml-2"></div>
                                    <span class="text-sm text-gray-700">طب الأطفال</span>
                                </div>
                                <span class="text-sm font-medium text-gray-900">18%</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-purple-500 rounded-full ml-2"></div>
                                    <span class="text-sm text-gray-700">الطب النفسي</span>
                                </div>
                                <span class="text-sm font-medium text-gray-900">15%</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-orange-500 rounded-full ml-2"></div>
                                    <span class="text-sm text-gray-700">طب الجلدية</span>
                                </div>
                                <span class="text-sm font-medium text-gray-900">12%</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-red-500 rounded-full ml-2"></div>
                                    <span class="text-sm text-gray-700">أخرى</span>
                                </div>
                                <span class="text-sm font-medium text-gray-900">32%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Daily Report -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">📊 التقرير اليومي</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">تسجيلات دخول</span>
                                <span class="text-sm font-medium text-gray-900">156</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">استشارات جديدة</span>
                                <span class="text-sm font-medium text-gray-900">23</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">طلبات انضمام</span>
                                <span class="text-sm font-medium text-gray-900">3</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">أطباء نشطين</span>
                                <span class="text-sm font-medium text-gray-900">89</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Report -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">📈 تقرير الأداء</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">وقت الاستجابة</span>
                                <span class="text-sm font-medium text-green-600">2.3 دقيقة</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">معدل الرضا</span>
                                <span class="text-sm font-medium text-green-600">4.7/5</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">معدل الإكمال</span>
                                <span class="text-sm font-medium text-green-600">94%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">استخدام النظام</span>
                                <span class="text-sm font-medium text-blue-600">87%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Report -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">💰 التقرير المالي</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">إيرادات اليوم</span>
                                <span class="text-sm font-medium text-gray-900">₹1,450</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">إيرادات الشهر</span>
                                <span class="text-sm font-medium text-gray-900">₹45,230</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">عمولة المنصة</span>
                                <span class="text-sm font-medium text-gray-900">₹4,523</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">النمو الشهري</span>
                                <span class="text-sm font-medium text-green-600">+15.2%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="content-settings" class="tab-content hidden">
                <!-- Settings Header -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">إعدادات النظام</h3>
                        <button onclick="saveAllSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            💾 حفظ جميع الإعدادات
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- General Settings -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">⚙️ الإعدادات العامة</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">تفعيل التسجيل الجديد</label>
                                    <p class="text-xs text-gray-500">السماح للأطباء الجدد بالتسجيل</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="newRegistration" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">مراجعة طلبات الانضمام</label>
                                    <p class="text-xs text-gray-500">مراجعة تلقائية أم يدوية</p>
                                </div>
                                <select id="reviewMode" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="auto">تلقائي</option>
                                    <option value="manual" selected>يدوي</option>
                                </select>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">إشعارات المدير</label>
                                    <p class="text-xs text-gray-500">تلقي إشعارات الأنشطة المهمة</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="adminNotifications" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">وضع الصيانة</label>
                                    <p class="text-xs text-gray-500">إيقاف المنصة مؤقتاً للصيانة</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="maintenanceMode" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">🔒 إعدادات الأمان</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">تسجيل العمليات</label>
                                    <p class="text-xs text-gray-500">تسجيل جميع العمليات الإدارية</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auditLogging" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">التحقق الثنائي</label>
                                    <p class="text-xs text-gray-500">تفعيل التحقق الثنائي للمدراء</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="twoFactorAuth" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">انتهاء صلاحية الجلسة</label>
                                    <p class="text-xs text-gray-500">مدة انتهاء جلسة المدير (بالدقائق)</p>
                                </div>
                                <select id="sessionTimeout" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="30">30 دقيقة</option>
                                    <option value="60" selected>60 دقيقة</option>
                                    <option value="120">120 دقيقة</option>
                                    <option value="240">240 دقيقة</option>
                                </select>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">تشفير البيانات</label>
                                    <p class="text-xs text-gray-500">تشفير البيانات الحساسة</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">مفعل</span>
                            </div>
                        </div>
                    </div>

                    <!-- Platform Settings -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">🏥 إعدادات المنصة</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">اسم المنصة</label>
                                <input type="text" id="platformName" value="طريقتي العلاجي" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">وصف المنصة</label>
                                <textarea id="platformDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">منصة طبية متقدمة تربط المرضى بالأطباء المختصين لتقديم استشارات طبية عالية الجودة</textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني للدعم</label>
                                <input type="email" id="supportEmail" value="support@tariqi-alilaji.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">رقم الدعم الفني</label>
                                <input type="tel" id="supportPhone" value="+966 11 123 4567" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">🔔 إعدادات الإشعارات</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">إشعارات البريد الإلكتروني</label>
                                    <p class="text-xs text-gray-500">إرسال إشعارات عبر البريد الإلكتروني</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="emailNotifications" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">إشعارات الرسائل النصية</label>
                                    <p class="text-xs text-gray-500">إرسال إشعارات عبر الرسائل النصية</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="smsNotifications" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">إشعارات الدفع</label>
                                    <p class="text-xs text-gray-500">إشعارات العمليات المالية</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="pushNotifications" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="mt-6 bg-white rounded-lg shadow p-6">
                    <div class="admin-warning p-4 rounded-lg">
                        <h4 class="font-medium text-admin-700 mb-2">⚠️ منطقة خطر</h4>
                        <p class="text-sm text-admin-600 mb-4">العمليات التالية تؤثر على النظام بالكامل ولا يمكن التراجع عنها</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="backupSystem()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                                <div class="text-center">
                                    <div class="text-xl mb-1">💾</div>
                                    <div class="text-sm font-medium">نسخ احتياطي</div>
                                    <div class="text-xs opacity-80">إنشاء نسخة احتياطية</div>
                                </div>
                            </button>
                            <button onclick="restoreSystem()" class="bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700 transition-colors">
                                <div class="text-center">
                                    <div class="text-xl mb-1">🔄</div>
                                    <div class="text-sm font-medium">استعادة النظام</div>
                                    <div class="text-xs opacity-80">استعادة من نسخة احتياطية</div>
                                </div>
                            </button>
                            <button onclick="resetSystem()" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition-colors">
                                <div class="text-center">
                                    <div class="text-xl mb-1">🗑️</div>
                                    <div class="text-sm font-medium">إعادة تعيين</div>
                                    <div class="text-xs opacity-80">حذف جميع البيانات</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <script>
        // Enhanced admin authentication with fallback
        function checkAdminAuth() {
            // Check both localStorage and sessionStorage for compatibility
            const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            const userType = localStorage.getItem('userType') || sessionStorage.getItem('userType');
            const urlParams = new URLSearchParams(window.location.search);
            const adminToken = urlParams.get('admin');

            console.log('🔍 فحص حالة المدير:', {
                currentUser: !!currentUser,
                userType,
                adminToken,
                url: window.location.href
            });

            // إذا كان هناك token في الرابط، قم بتسجيل دخول تلقائي
            if (adminToken === 'ADMIN001' || adminToken === 'true') {
                console.log('🔑 تسجيل دخول تلقائي للمدير من الرابط');
                const adminUser = {
                    name: 'مدير المنصة',
                    license: 'ADMIN001',
                    email: 'admin@tariqi-alilaji.com',
                    phone: '+966 11 123 4567',
                    userType: 'admin',
                    specialty: 'إدارة النظام'
                };

                // حفظ في كلا المكانين للتوافق
                localStorage.setItem('currentUser', JSON.stringify(adminUser));
                localStorage.setItem('userType', 'admin');
                sessionStorage.setItem('currentUser', JSON.stringify(adminUser));
                sessionStorage.setItem('userType', 'admin');

                // إزالة المعامل من الرابط
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);

                return true;
            }

            // التحقق العادي
            if (!currentUser || userType !== 'admin') {
                console.log('❌ المستخدم غير مسجل أو ليس مدير');

                // عرض نموذج تسجيل دخول بدلاً من التوجيه المباشر
                showAdminLoginModal();
                return false;
            }

            try {
                const user = JSON.parse(currentUser);
                console.log('✅ مدير مسجل:', user.name);

                // Set admin session
                sessionStorage.setItem('userType', 'admin');

                return true;
            } catch (error) {
                console.error('❌ خطأ في قراءة بيانات المدير:', error);
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userType');
                showAdminLoginModal();
                return false;
            }
        }

        // عرض نموذج تسجيل دخول المدير
        function showAdminLoginModal() {
            const modalHtml = `
                <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-white text-2xl">⚙️</span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900">تسجيل دخول المدير</h2>
                            <p class="text-gray-600 mt-2">يرجى تسجيل الدخول للوصول لوحة تحكم المدير</p>
                        </div>

                        <form id="adminLoginForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم:</label>
                                <input type="text" id="adminUsername" value="ADMIN001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور:</label>
                                <input type="password" id="adminPassword" placeholder="admin123" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                                🔐 دخول لوحة التحكم
                            </button>
                        </form>

                        <div class="mt-6 text-center">
                            <button onclick="goToHomePage()" class="text-gray-600 hover:text-gray-800 text-sm">
                                🏠 العودة للصفحة الرئيسية
                            </button>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-yellow-800 text-xs">
                                💡 للاختبار: كلمة المرور هي <strong>admin123</strong>
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // معالج تسجيل الدخول
            document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;

                if (username === 'ADMIN001' && password === 'admin123') {
                    const adminUser = {
                        name: 'مدير المنصة',
                        license: 'ADMIN001',
                        email: 'admin@tariqi-alilaji.com',
                        phone: '+966 11 123 4567',
                        userType: 'admin',
                        specialty: 'إدارة النظام'
                    };

                    localStorage.setItem('currentUser', JSON.stringify(adminUser));
                    localStorage.setItem('userType', 'admin');
                    sessionStorage.setItem('userType', 'admin');

                    // إزالة النموذج
                    document.getElementById('adminLoginModal').remove();

                    // إعادة تحميل الصفحة
                    window.location.reload();
                } else {
                    alert('❌ كلمة المرور غير صحيحة');
                }
            });

            // التركيز على حقل كلمة المرور
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);
        }

        // العودة للصفحة الرئيسية
        function goToHomePage() {
            window.location.href = 'index.html';
        }

        // Enhanced initialization with Firebase
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 تحميل لوحة تحكم المدير المحسنة...');

            // Wait for Firebase to load
            setTimeout(() => {
                if (!checkAdminAuth()) {
                    console.log('🔐 عرض نموذج تسجيل دخول المدير');
                } else {
                    console.log('✅ المدير مسجل دخول - تحميل لوحة التحكم');

                    // Initialize features
                    initializeAdminDashboard();
                }
            }, 1000);
        });

        // Initialize admin dashboard features
        async function initializeAdminDashboard() {
            try {
                console.log('🔧 تهيئة ميزات لوحة التحكم...');

                // Setup real-time updates
                setupRealTimeUpdates();

                // Load initial data for overview
                await loadReportsDataFast();

                // Setup auto-refresh every 5 minutes
                setInterval(() => {
                    console.log('🔄 تحديث تلقائي للبيانات');
                    window.cachedData = null; // Clear cache

                    // Refresh current tab data
                    const activeTab = document.querySelector('[id^="tab-"].bg-admin-100');
                    if (activeTab) {
                        const tabName = activeTab.id.replace('tab-', '');
                        if (tabName === 'overview' || tabName === 'reports') {
                            loadReportsDataFast();
                        } else if (tabName === 'doctors') {
                            loadDoctors();
                        } else if (tabName === 'requests') {
                            loadRequests();
                        }
                    }
                }, 5 * 60 * 1000); // 5 minutes

                console.log('✅ تم تهيئة لوحة التحكم بنجاح');

            } catch (error) {
                console.error('❌ خطأ في تهيئة لوحة التحكم:', error);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            cleanupRealTimeUpdates();
        });



        // Enhanced Firebase Doctors Management Functions
        async function loadDoctors() {
            try {
                window.performanceMonitor.start('تحميل بيانات الأطباء');

                // Show loading state with better animation
                showLoadingState('doctors');

                // Use helper function for database operations
                const doctors = await window.dbHelpers.getData('doctors');

                // Sort by creation date (newest first)
                doctors.sort((a, b) => {
                    const aTime = a.createdAt?.seconds || a.createdAt || 0;
                    const bTime = b.createdAt?.seconds || b.createdAt || 0;
                    return bTime - aTime;
                });

                window.performanceMonitor.end('تحميل بيانات الأطباء');
                console.log(`✅ تم تحميل ${doctors.length} طبيب`);

                // Hide loading and show results
                hideLoadingState('doctors');

                if (doctors.length === 0) {
                    showEmptyState('doctors');
                } else {
                    showDataState('doctors');
                    renderDoctorsTable(doctors);
                }

            } catch (error) {
                console.error('❌ خطأ في تحميل الأطباء:', error);
                hideLoadingState('doctors');
                showErrorState('doctors');
                showWarningMessage('فشل في تحميل بيانات الأطباء');
            }
        }

        // UI State Management Functions
        function showLoadingState(section) {
            document.getElementById(`${section}Loading`).classList.remove('hidden');
            document.getElementById(`${section}Table`).classList.add('hidden');
            document.getElementById(`${section}List`).classList.add('hidden');
            document.getElementById(`${section}Empty`).classList.add('hidden');
            document.getElementById(`${section}Error`).classList.add('hidden');
        }

        function hideLoadingState(section) {
            document.getElementById(`${section}Loading`).classList.add('hidden');
        }

        function showDataState(section) {
            if (section === 'doctors') {
                document.getElementById('doctorsTable').classList.remove('hidden');
            } else if (section === 'requests') {
                document.getElementById('requestsList').classList.remove('hidden');
            }
        }

        function showEmptyState(section) {
            document.getElementById(`${section}Empty`).classList.remove('hidden');
        }

        function showErrorState(section) {
            document.getElementById(`${section}Error`).classList.remove('hidden');
        }

        function renderDoctorsTable(doctors) {
            const tbody = document.getElementById('doctorsTableBody');
            tbody.innerHTML = '';

            doctors.forEach(doctor => {
                const createdDate = doctor.createdAt ?
                    new Date(doctor.createdAt.seconds * 1000).toLocaleDateString('ar-SA') :
                    'غير محدد';

                const statusClass = doctor.status === 'active' ?
                    'bg-green-100 text-green-800' :
                    'bg-red-100 text-red-800';

                const statusText = doctor.status === 'active' ? 'نشط' : 'معطل';

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${doctor.name || 'غير محدد'}</div>
                                <div class="text-sm text-gray-500">${doctor.license || 'غير محدد'}</div>
                                <div class="text-sm text-gray-500">${doctor.email || 'غير محدد'}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doctor.specialty || 'غير محدد'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doctor.hospital || 'غير محدد'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${createdDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2 space-x-reverse">
                            <button onclick="viewDoctor('${doctor.id}')" class="text-blue-600 hover:text-blue-900">
                                👁️ عرض
                            </button>
                            <button onclick="toggleDoctorStatus('${doctor.id}', '${doctor.status}')" class="text-orange-600 hover:text-orange-900">
                                ${doctor.status === 'active' ? '⏸️ إيقاف' : '▶️ تفعيل'}
                            </button>
                            <button onclick="deleteDoctor('${doctor.id}')" class="text-red-600 hover:text-red-900">
                                🗑️ حذف
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        async function viewDoctor(doctorId) {
            try {
                const { doc, getDoc } = window.firebaseModules;
                const docRef = doc(window.db, 'doctors', doctorId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const doctor = docSnap.data();
                    const createdDate = doctor.createdAt ?
                        new Date(doctor.createdAt.seconds * 1000).toLocaleDateString('ar-SA') :
                        'غير محدد';

                    alert(`تفاصيل الطبيب:
الاسم: ${doctor.name || 'غير محدد'}
التخصص: ${doctor.specialty || 'غير محدد'}
رقم الترخيص: ${doctor.license || 'غير محدد'}
البريد الإلكتروني: ${doctor.email || 'غير محدد'}
الهاتف: ${doctor.phone || 'غير محدد'}
المستشفى: ${doctor.hospital || 'غير محدد'}
الخبرة: ${doctor.experience || 'غير محدد'}
الحالة: ${doctor.status === 'active' ? 'نشط' : 'معطل'}
تاريخ التسجيل: ${createdDate}`);
                } else {
                    showWarningMessage('لم يتم العثور على بيانات الطبيب');
                }
            } catch (error) {
                console.error('خطأ في عرض تفاصيل الطبيب:', error);
                showWarningMessage('فشل في تحميل تفاصيل الطبيب');
            }
        }

        async function toggleDoctorStatus(doctorId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const actionText = newStatus === 'active' ? 'تفعيل' : 'إيقاف';

            if (confirm(`⚠️ هل أنت متأكد من ${actionText} هذا الطبيب؟`)) {
                try {
                    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
                    const docRef = doc(window.db, 'doctors', doctorId);

                    await updateDoc(docRef, {
                        status: newStatus,
                        updatedAt: serverTimestamp()
                    });

                    showSuccessMessage(`تم ${actionText} الطبيب بنجاح`);
                    loadDoctors(); // Refresh the table
                } catch (error) {
                    console.error('خطأ في تحديث حالة الطبيب:', error);
                    showWarningMessage('فشل في تحديث حالة الطبيب');
                }
            }
        }

        async function deleteDoctor(doctorId) {
            if (confirm('⚠️ تحذير: هل أنت متأكد من حذف هذا الطبيب؟\nهذا الإجراء لا يمكن التراجع عنه وسيؤثر على جميع بياناته.')) {
                const confirmation = prompt('اكتب "حذف" للتأكيد:');
                if (confirmation === 'حذف') {
                    try {
                        const { doc, deleteDoc } = window.firebaseModules;
                        const docRef = doc(window.db, 'doctors', doctorId);

                        await deleteDoc(docRef);

                        showSuccessMessage('تم حذف الطبيب بنجاح');
                        loadDoctors(); // Refresh the table
                    } catch (error) {
                        console.error('خطأ في حذف الطبيب:', error);
                        showWarningMessage('فشل في حذف الطبيب');
                    }
                }
            }
        }

        function refreshDoctors() {
            loadDoctors();
        }

        function exportDoctors() {
            showSuccessMessage('جاري تصدير بيانات الأطباء...');
            // يمكن إضافة وظيفة التصدير هنا
        }

        // Enhanced Firebase Requests Management Functions
        async function loadRequests() {
            try {
                window.performanceMonitor.start('تحميل طلبات الانضمام');

                // Show loading state
                showLoadingState('requests');

                // Get all requests and filter pending ones
                const allRequests = await window.dbHelpers.getData('joinRequests');
                const requests = allRequests
                    .filter(request => request.status === 'pending')
                    .sort((a, b) => {
                        const aTime = a.createdAt?.seconds || a.createdAt || 0;
                        const bTime = b.createdAt?.seconds || b.createdAt || 0;
                        return bTime - aTime;
                    });

                window.performanceMonitor.end('تحميل طلبات الانضمام');
                console.log(`✅ تم تحميل ${requests.length} طلب انضمام معلق`);

                // Hide loading and show results
                hideLoadingState('requests');

                if (requests.length === 0) {
                    showEmptyState('requests');
                } else {
                    showDataState('requests');
                    renderRequestsList(requests);
                }

            } catch (error) {
                console.error('❌ خطأ في تحميل طلبات الانضمام:', error);
                hideLoadingState('requests');
                showErrorState('requests');
                showWarningMessage('فشل في تحميل طلبات الانضمام');
            }
        }

        function renderRequestsList(requests) {
            const container = document.getElementById('requestsList');
            container.innerHTML = '';

            requests.forEach(request => {
                const createdDate = request.createdAt ?
                    new Date(request.createdAt.seconds * 1000).toLocaleDateString('ar-SA') :
                    'غير محدد';

                const requestCard = `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${request.name || 'غير محدد'}</h4>
                                <p class="text-sm text-gray-600">${request.specialty || 'غير محدد'} • ${request.license || 'غير محدد'}</p>
                                <p class="text-sm text-gray-600">${request.email || 'غير محدد'} • ${request.phone || 'غير محدد'}</p>
                                <p class="text-sm text-gray-600">المستشفى: ${request.hospital || 'غير محدد'}</p>
                                <p class="text-sm text-gray-600">الخبرة: ${request.experience || 'غير محدد'}</p>
                                <p class="text-xs text-gray-500">تاريخ التقديم: ${createdDate}</p>
                                ${request.bio ? `<p class="text-sm text-gray-600 mt-2">النبذة: ${request.bio}</p>` : ''}
                            </div>
                            <div class="flex space-x-2 space-x-reverse mr-4">
                                <button onclick="approveRequest('${request.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                    ✅ موافقة
                                </button>
                                <button onclick="rejectRequest('${request.id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                    ❌ رفض
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += requestCard;
            });
        }

        async function approveRequest(requestId) {
            try {
                // Get request data first
                const { doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } = window.firebaseModules;
                const requestRef = doc(window.db, 'joinRequests', requestId);
                const requestSnap = await getDoc(requestRef);

                if (!requestSnap.exists()) {
                    showWarningMessage('لم يتم العثور على الطلب');
                    return;
                }

                const requestData = requestSnap.data();

                if (confirm(`هل تريد الموافقة على طلب انضمام ${requestData.name}؟`)) {
                    // Add doctor to doctors collection
                    const doctorData = {
                        name: requestData.name,
                        email: requestData.email,
                        phone: requestData.phone,
                        specialty: requestData.specialty,
                        license: requestData.license,
                        hospital: requestData.hospital,
                        experience: requestData.experience,
                        bio: requestData.bio,
                        status: 'active',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };

                    await addDoc(collection(window.db, 'doctors'), doctorData);

                    // Update request status
                    await updateDoc(requestRef, {
                        status: 'approved',
                        approvedAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });

                    showSuccessMessage(`تم قبول طلب انضمام ${requestData.name} بنجاح`);
                    loadRequests(); // Refresh the list
                }
            } catch (error) {
                console.error('خطأ في الموافقة على الطلب:', error);
                showWarningMessage('فشل في الموافقة على الطلب');
            }
        }

        async function rejectRequest(requestId) {
            try {
                const { doc, getDoc, updateDoc, serverTimestamp } = window.firebaseModules;
                const requestRef = doc(window.db, 'joinRequests', requestId);
                const requestSnap = await getDoc(requestRef);

                if (!requestSnap.exists()) {
                    showWarningMessage('لم يتم العثور على الطلب');
                    return;
                }

                const requestData = requestSnap.data();
                const reason = prompt('سبب الرفض (اختياري):');

                if (confirm(`هل تريد رفض طلب انضمام ${requestData.name}؟`)) {
                    await updateDoc(requestRef, {
                        status: 'rejected',
                        rejectionReason: reason || '',
                        rejectedAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });

                    showSuccessMessage(`تم رفض طلب انضمام ${requestData.name}`);
                    loadRequests(); // Refresh the list
                }
            } catch (error) {
                console.error('خطأ في رفض الطلب:', error);
                showWarningMessage('فشل في رفض الطلب');
            }
        }

        function refreshRequests() {
            loadRequests();
        }

        // System functions
        function backupSystem() {
            if (confirm('هل تريد إنشاء نسخة احتياطية من النظام؟')) {
                showSuccessMessage('جاري إنشاء النسخة الاحتياطية...');
                setTimeout(() => {
                    showSuccessMessage('تم إنشاء النسخة الاحتياطية بنجاح');
                }, 3000);
            }
        }

        function restoreSystem() {
            if (confirm('⚠️ هل تريد استعادة النظام من نسخة احتياطية؟\nسيتم استبدال البيانات الحالية!')) {
                const backupFile = prompt('أدخل اسم ملف النسخة الاحتياطية:');
                if (backupFile) {
                    showSuccessMessage('جاري استعادة النظام...');
                    setTimeout(() => {
                        showSuccessMessage('تم استعادة النظام بنجاح');
                    }, 4000);
                }
            }
        }

        function resetSystem() {
            if (confirm('⚠️ تحذير شديد: هل تريد إعادة تعيين النظام؟\nسيتم حذف جميع البيانات!')) {
                if (prompt('اكتب "إعادة تعيين" للتأكيد:') === 'إعادة تعيين') {
                    alert('تم إلغاء العملية لأغراض الأمان');
                }
            }
        }

        // Enhanced Firebase Reports Functions
        async function loadReportsData() {
            try {
                window.performanceMonitor.start('تحميل بيانات التقارير');
                console.log('📊 جاري تحميل بيانات التقارير من Firebase...');

                // Load data in parallel for better performance
                const [doctors, requests] = await Promise.all([
                    window.dbHelpers.getData('doctors'),
                    window.dbHelpers.getData('joinRequests')
                ]);

                // Calculate statistics
                const stats = calculateStatistics(doctors, requests);
                updateReportsUI(stats);

                // Store data for future use
                window.cachedData = { doctors, requests, lastUpdate: Date.now() };

                window.performanceMonitor.end('تحميل بيانات التقارير');
                console.log('✅ تم تحميل بيانات التقارير بنجاح');

            } catch (error) {
                console.error('❌ خطأ في تحميل بيانات التقارير:', error);
                showWarningMessage('فشل في تحميل بيانات التقارير');
            }
        }

        // Cache management for better performance
        function getCachedData() {
            const cache = window.cachedData;
            const cacheAge = Date.now() - (cache?.lastUpdate || 0);
            const maxAge = 5 * 60 * 1000; // 5 minutes

            if (cache && cacheAge < maxAge) {
                console.log('📋 استخدام البيانات المخزنة مؤقتاً');
                return cache;
            }
            return null;
        }

        // Fast reports loading with cache
        async function loadReportsDataFast() {
            const cached = getCachedData();
            if (cached) {
                const stats = calculateStatistics(cached.doctors, cached.requests);
                updateReportsUI(stats);
                return;
            }
            await loadReportsData();
        }

        function calculateStatistics(doctors, requests) {
            const now = new Date();
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            // Active doctors
            const activeDoctors = doctors.filter(d => d.status === 'active');

            // New doctors this month
            const newDoctorsThisMonth = doctors.filter(d => {
                if (!d.createdAt) return false;
                const createdDate = new Date(d.createdAt.seconds * 1000);
                return createdDate >= thisMonth;
            });

            // Pending requests
            const pendingRequests = requests.filter(r => r.status === 'pending');

            // Specialties distribution
            const specialties = {};
            doctors.forEach(doctor => {
                const specialty = doctor.specialty || 'غير محدد';
                specialties[specialty] = (specialties[specialty] || 0) + 1;
            });

            return {
                totalDoctors: doctors.length,
                activeDoctors: activeDoctors.length,
                newDoctorsThisMonth: newDoctorsThisMonth.length,
                pendingRequests: pendingRequests.length,
                specialties: specialties,
                totalRequests: requests.length,
                approvedRequests: requests.filter(r => r.status === 'approved').length,
                rejectedRequests: requests.filter(r => r.status === 'rejected').length
            };
        }

        function updateReportsUI(stats) {
            // Update overview cards
            const overviewCards = document.querySelectorAll('#content-overview .grid .bg-white');
            if (overviewCards.length >= 4) {
                // Total doctors card
                overviewCards[0].querySelector('.text-2xl').textContent = stats.totalDoctors.toLocaleString();

                // Active doctors (using as consultations for now)
                overviewCards[1].querySelector('.text-2xl').textContent = (stats.activeDoctors * 15).toLocaleString();

                // Active users (using active doctors)
                overviewCards[2].querySelector('.text-2xl').textContent = stats.activeDoctors;

                // Pending requests
                overviewCards[3].querySelector('.text-2xl').textContent = stats.pendingRequests;
            }

            // Update reports cards
            updateReportsCards(stats);

            // Update specialties distribution
            updateSpecialtiesDistribution(stats.specialties);
        }

        function updateReportsCards(stats) {
            // Update daily report
            const dailyReport = document.querySelector('#content-reports .grid .bg-white:nth-child(1)');
            if (dailyReport) {
                const rows = dailyReport.querySelectorAll('.flex.justify-between span:last-child');
                if (rows.length >= 4) {
                    rows[0].textContent = Math.floor(stats.activeDoctors * 0.7); // Simulated logins
                    rows[1].textContent = Math.floor(stats.activeDoctors * 0.3); // Simulated consultations
                    rows[2].textContent = stats.pendingRequests;
                    rows[3].textContent = stats.activeDoctors;
                }
            }

            // Update performance report
            const performanceReport = document.querySelector('#content-reports .grid .bg-white:nth-child(2)');
            if (performanceReport) {
                const rows = performanceReport.querySelectorAll('.flex.justify-between span:last-child');
                if (rows.length >= 4) {
                    rows[0].textContent = '2.3 دقيقة';
                    rows[1].textContent = '4.7/5';
                    rows[2].textContent = Math.floor((stats.activeDoctors / stats.totalDoctors) * 100) + '%';
                    rows[3].textContent = Math.floor(Math.random() * 20 + 80) + '%';
                }
            }

            // Update financial report
            const financialReport = document.querySelector('#content-reports .grid .bg-white:nth-child(3)');
            if (financialReport) {
                const rows = financialReport.querySelectorAll('.flex.justify-between span:last-child');
                if (rows.length >= 4) {
                    rows[0].textContent = '₹' + (Math.floor(Math.random() * 2000 + 1000)).toLocaleString();
                    rows[1].textContent = '₹' + (stats.activeDoctors * 1500).toLocaleString();
                    rows[2].textContent = '₹' + (stats.activeDoctors * 150).toLocaleString();
                    rows[3].textContent = '+' + Math.floor(Math.random() * 20 + 10) + '%';
                }
            }
        }

        function updateSpecialtiesDistribution(specialties) {
            const container = document.querySelector('#content-reports .space-y-3');
            if (!container) return;

            const total = Object.values(specialties).reduce((sum, count) => sum + count, 0);
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-red-500'];

            container.innerHTML = '';

            Object.entries(specialties)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .forEach(([specialty, count], index) => {
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    const colorClass = colors[index] || 'bg-gray-500';

                    const row = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 ${colorClass} rounded-full ml-2"></div>
                                <span class="text-sm text-gray-700">${specialty}</span>
                            </div>
                            <span class="text-sm font-medium text-gray-900">${percentage}%</span>
                        </div>
                    `;
                    container.innerHTML += row;
                });
        }

        function exportReport() {
            const period = document.getElementById('reportPeriod').value;
            showSuccessMessage(`جاري تصدير تقرير ${period}...`);
            setTimeout(() => {
                showSuccessMessage('تم تصدير التقرير بنجاح');
            }, 2000);
        }

        // Settings functions
        function saveAllSettings() {
            const settings = {
                newRegistration: document.getElementById('newRegistration').checked,
                reviewMode: document.getElementById('reviewMode').value,
                adminNotifications: document.getElementById('adminNotifications').checked,
                maintenanceMode: document.getElementById('maintenanceMode').checked,
                auditLogging: document.getElementById('auditLogging').checked,
                twoFactorAuth: document.getElementById('twoFactorAuth').checked,
                sessionTimeout: document.getElementById('sessionTimeout').value,
                platformName: document.getElementById('platformName').value,
                platformDescription: document.getElementById('platformDescription').value,
                supportEmail: document.getElementById('supportEmail').value,
                supportPhone: document.getElementById('supportPhone').value,
                emailNotifications: document.getElementById('emailNotifications').checked,
                smsNotifications: document.getElementById('smsNotifications').checked,
                pushNotifications: document.getElementById('pushNotifications').checked
            };

            console.log('حفظ الإعدادات:', settings);
            showSuccessMessage('تم حفظ جميع الإعدادات بنجاح');
        }

        function logout() {
            // Clear both storages completely
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userType');
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('userType');

            showSuccessMessage('تم تسجيل الخروج بنجاح');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        // Utility functions
        function showSuccessMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 3000);
        }

        function showWarningMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'fixed top-4 left-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            messageEl.textContent = message;
            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (document.body.contains(messageEl)) {
                    document.body.removeChild(messageEl);
                }
            }, 4000);
        }

        // Initialize charts
        function initializeCharts() {
            // Growth Chart
            const growthCtx = document.getElementById('growthChart');
            if (growthCtx) {
                new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{
                            label: 'عدد الأطباء',
                            data: [120, 190, 300, 500, 700, 847],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'عدد الاستشارات',
                            data: [800, 1200, 1800, 2500, 3200, 4200],
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Initialize admin session
        sessionStorage.setItem('userType', 'admin');

        // Enhanced tab management with Firebase data loading and caching
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.className = 'flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100';
            });

            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // Add active class to selected tab
            document.getElementById(`tab-${tabName}`).className = 'flex items-center px-3 py-2 text-sm font-medium rounded-md bg-admin-100 text-admin-700';

            // Load data based on selected tab with performance optimization
            switch(tabName) {
                case 'overview':
                    loadReportsDataFast(); // Use cached data if available
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'reports':
                    setTimeout(() => {
                        initializeCharts();
                        loadReportsDataFast();
                    }, 100);
                    break;
                case 'settings':
                    // Settings don't need Firebase data
                    break;
            }

            // Track tab usage for analytics
            if (window.analytics) {
                console.log(`📊 تم الانتقال إلى تبويب: ${tabName}`);
            }
        }

        // Real-time updates setup
        function setupRealTimeUpdates() {
            if (!window.dbHelpers.useFirestore) return; // Only for Firestore

            try {
                const { collection, onSnapshot } = window.firebaseModules;

                // Listen for doctors changes
                const doctorsUnsubscribe = onSnapshot(collection(window.db, 'doctors'), (snapshot) => {
                    console.log('🔄 تحديث في بيانات الأطباء');
                    if (document.getElementById('content-doctors').classList.contains('hidden') === false) {
                        loadDoctors();
                    }
                    // Clear cache
                    window.cachedData = null;
                });

                // Listen for requests changes
                const requestsUnsubscribe = onSnapshot(collection(window.db, 'joinRequests'), (snapshot) => {
                    console.log('🔄 تحديث في طلبات الانضمام');
                    if (document.getElementById('content-requests').classList.contains('hidden') === false) {
                        loadRequests();
                    }
                    // Clear cache
                    window.cachedData = null;
                });

                // Store unsubscribe functions for cleanup
                window.realtimeUnsubscribes = [doctorsUnsubscribe, requestsUnsubscribe];

                console.log('🔴 تم تفعيل التحديثات الفورية');
            } catch (error) {
                console.error('❌ خطأ في إعداد التحديثات الفورية:', error);
            }
        }

        // Cleanup real-time listeners
        function cleanupRealTimeUpdates() {
            if (window.realtimeUnsubscribes) {
                window.realtimeUnsubscribes.forEach(unsubscribe => unsubscribe());
                console.log('🔴 تم إيقاف التحديثات الفورية');
            }
        }

        // Add sample data if needed
        async function addSampleDataIfNeeded() {
            try {
                const { collection, getDocs, addDoc, serverTimestamp } = window.firebaseModules;

                // Check if we have any doctors
                const doctorsSnapshot = await getDocs(collection(window.db, 'doctors'));
                if (doctorsSnapshot.empty) {
                    console.log('📝 إضافة بيانات تجريبية...');

                    // Add sample doctors
                    const sampleDoctors = [
                        {
                            name: 'د. أحمد محمد',
                            email: 'ahmed@example.com',
                            phone: '+966501234567',
                            specialty: 'طب القلب',
                            license: 'DOC001',
                            hospital: 'مستشفى الملك فيصل',
                            experience: '10 سنوات',
                            bio: 'طبيب متخصص في طب القلب',
                            status: 'active',
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        },
                        {
                            name: 'د. فاطمة علي',
                            email: 'fatima@example.com',
                            phone: '+966507654321',
                            specialty: 'طب الأطفال',
                            license: 'DOC002',
                            hospital: 'مستشفى الملك خالد',
                            experience: '8 سنوات',
                            bio: 'طبيبة متخصصة في طب الأطفال',
                            status: 'active',
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        }
                    ];

                    for (const doctor of sampleDoctors) {
                        await addDoc(collection(window.db, 'doctors'), doctor);
                    }

                    // Add sample requests
                    const sampleRequests = [
                        {
                            name: 'د. سارة أحمد',
                            email: 'sara@example.com',
                            phone: '+966509876543',
                            specialty: 'طب الجلدية',
                            license: 'DOC003',
                            hospital: 'مستشفى الملك عبدالعزيز',
                            experience: '5 سنوات',
                            bio: 'طبيبة متخصصة في طب الجلدية',
                            status: 'pending',
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        }
                    ];

                    for (const request of sampleRequests) {
                        await addDoc(collection(window.db, 'joinRequests'), request);
                    }

                    console.log('✅ تم إضافة البيانات التجريبية');
                }
            } catch (error) {
                console.error('❌ خطأ في إضافة البيانات التجريبية:', error);
            }
        }

        // Welcome message
        setTimeout(() => {
            showSuccessMessage('مرحباً بك في لوحة تحكم المدير!');
            // Add sample data after welcome
            addSampleDataIfNeeded();
        }, 500);

        // Security reminder
        setTimeout(() => {
            showWarningMessage('⚠️ تذكير: أنت في وضع المدير - كن حذراً مع العمليات الحساسة');
        }, 3000);
    </script>
</body>
</html>
